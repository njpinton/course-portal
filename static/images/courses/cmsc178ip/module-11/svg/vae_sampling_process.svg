<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 850 400" role="img" aria-label="VAE reparameterization trick for backpropagation through sampling">
  <title>VAE Sampling Process</title>
  <desc>Reparameterization trick showing how to sample from latent distribution while maintaining gradient flow for backpropagation</desc>

  <defs>
    <linearGradient id="sampBg" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#f8f9fa"/>
      <stop offset="100%" style="stop-color:#e9ecef"/>
    </linearGradient>
    <marker id="sampArrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#666"/>
    </marker>
  </defs>

  <rect width="850" height="400" fill="url(#sampBg)" rx="8"/>

  <!-- Title -->
  <text x="425" y="32" fill="#1a3a6e" font-family="Segoe UI, sans-serif" font-size="20" font-weight="600" text-anchor="middle">VAE Sampling: Reparameterization Trick</text>

  <!-- The problem -->
  <g transform="translate(30, 55)">
    <rect x="0" y="0" width="385" height="145" fill="white" rx="8" stroke="#ef4444" stroke-width="2"/>
    <text x="192" y="22" fill="#ef4444" font-family="Segoe UI, sans-serif" font-size="13" font-weight="600" text-anchor="middle">The Problem: Sampling Breaks Gradients</text>

    <g transform="translate(20, 45)">
      <!-- μ, σ -->
      <rect x="0" y="0" width="60" height="50" fill="#dbeafe" rx="4"/>
      <text x="30" y="30" fill="#3b82f6" font-family="Segoe UI, sans-serif" font-size="12" text-anchor="middle">μ, σ</text>

      <!-- Random sampling -->
      <g transform="translate(90, 0)">
        <rect x="0" y="0" width="100" height="50" fill="#fef2f2" stroke="#ef4444" stroke-width="2" rx="4"/>
        <text x="50" y="22" fill="#ef4444" font-family="Segoe UI, sans-serif" font-size="10" text-anchor="middle">z ~ N(μ, σ²)</text>
        <text x="50" y="38" fill="#ef4444" font-family="Segoe UI, sans-serif" font-size="9" text-anchor="middle">RANDOM</text>
      </g>

      <!-- z output -->
      <rect x="220" y="0" width="50" height="50" fill="#d1fae5" rx="4"/>
      <text x="245" y="30" fill="#10b981" font-family="Segoe UI, sans-serif" font-size="12" text-anchor="middle">z</text>

      <!-- Arrows -->
      <line x1="60" y1="25" x2="87" y2="25" stroke="#666" stroke-width="2" marker-end="url(#sampArrow)"/>
      <line x1="190" y1="25" x2="217" y2="25" stroke="#666" stroke-width="2" marker-end="url(#sampArrow)"/>

      <!-- X mark for gradient -->
      <g transform="translate(130, 55)">
        <line x1="0" y1="0" x2="20" y2="20" stroke="#ef4444" stroke-width="3"/>
        <line x1="20" y1="0" x2="0" y2="20" stroke="#ef4444" stroke-width="3"/>
        <text x="10" y="40" fill="#ef4444" font-family="Segoe UI, sans-serif" font-size="9" text-anchor="middle">No gradient!</text>
      </g>
    </g>

    <text x="192" y="130" fill="#666" font-family="Segoe UI, sans-serif" font-size="9" text-anchor="middle">Can't backpropagate through random sampling operation</text>
  </g>

  <!-- The solution -->
  <g transform="translate(435, 55)">
    <rect x="0" y="0" width="385" height="145" fill="white" rx="8" stroke="#10b981" stroke-width="2"/>
    <text x="192" y="22" fill="#10b981" font-family="Segoe UI, sans-serif" font-size="13" font-weight="600" text-anchor="middle">The Solution: Reparameterization Trick</text>

    <g transform="translate(20, 45)">
      <!-- μ, σ -->
      <rect x="0" y="0" width="60" height="50" fill="#dbeafe" rx="4"/>
      <text x="30" y="30" fill="#3b82f6" font-family="Segoe UI, sans-serif" font-size="12" text-anchor="middle">μ, σ</text>

      <!-- Deterministic operation -->
      <g transform="translate(90, 0)">
        <rect x="0" y="0" width="100" height="50" fill="#d1fae5" stroke="#10b981" stroke-width="2" rx="4"/>
        <text x="50" y="22" fill="#10b981" font-family="Segoe UI, sans-serif" font-size="10" text-anchor="middle">z = μ + σ·ε</text>
        <text x="50" y="38" fill="#10b981" font-family="Segoe UI, sans-serif" font-size="9" text-anchor="middle">DETERMINISTIC</text>
      </g>

      <!-- z output -->
      <rect x="220" y="0" width="50" height="50" fill="#d1fae5" rx="4"/>
      <text x="245" y="30" fill="#10b981" font-family="Segoe UI, sans-serif" font-size="12" text-anchor="middle">z</text>

      <!-- Epsilon input -->
      <ellipse cx="140" cy="85" rx="25" ry="18" fill="#f8f9fa" stroke="#666" stroke-width="1"/>
      <text x="140" y="85" fill="#666" font-family="Segoe UI, sans-serif" font-size="10" text-anchor="middle">ε~N(0,1)</text>

      <!-- Arrows -->
      <line x1="60" y1="25" x2="87" y2="25" stroke="#10b981" stroke-width="2" marker-end="url(#sampArrow)"/>
      <line x1="190" y1="25" x2="217" y2="25" stroke="#10b981" stroke-width="2" marker-end="url(#sampArrow)"/>
      <line x1="140" y1="67" x2="140" y2="53" stroke="#666" stroke-width="1" marker-end="url(#sampArrow)"/>

      <!-- Check mark for gradient -->
      <g transform="translate(125, 55)">
        <text x="35" y="-5" fill="#10b981" font-family="Segoe UI, sans-serif" font-size="16">✓</text>
      </g>
    </g>

    <text x="192" y="130" fill="#666" font-family="Segoe UI, sans-serif" font-size="9" text-anchor="middle">Randomness is external → gradient flows through μ and σ</text>
  </g>

  <!-- Formula explanation -->
  <g transform="translate(30, 215)">
    <rect x="0" y="0" width="520" height="160" fill="white" rx="8" stroke="#3b82f6" stroke-width="2"/>
    <text x="260" y="22" fill="#3b82f6" font-family="Segoe UI, sans-serif" font-size="13" font-weight="600" text-anchor="middle">Mathematical Details</text>

    <g transform="translate(20, 45)">
      <!-- Formula breakdown -->
      <text x="0" y="0" fill="#1a3a6e" font-family="Segoe UI, sans-serif" font-size="14" font-weight="600">z = μ + σ · ε</text>

      <g transform="translate(0, 25)" font-family="Segoe UI, sans-serif" font-size="10">
        <rect x="0" y="0" width="150" height="35" fill="#dbeafe" rx="3"/>
        <text x="75" y="15" fill="#3b82f6" font-weight="600" text-anchor="middle">μ = encoder output</text>
        <text x="75" y="30" fill="#666" text-anchor="middle">Learned mean</text>

        <rect x="165" y="0" width="150" height="35" fill="#d1fae5" rx="3"/>
        <text x="240" y="15" fill="#10b981" font-weight="600" text-anchor="middle">σ = exp(0.5·log_var)</text>
        <text x="240" y="30" fill="#666" text-anchor="middle">Learned std dev</text>

        <rect x="330" y="0" width="150" height="35" fill="#f8f9fa" rx="3"/>
        <text x="405" y="15" fill="#666" font-weight="600" text-anchor="middle">ε ~ N(0, 1)</text>
        <text x="405" y="30" fill="#666" text-anchor="middle">Random noise</text>
      </g>

      <!-- Why it works -->
      <g transform="translate(0, 75)" font-family="Segoe UI, sans-serif" font-size="9">
        <text x="0" y="0" fill="#333" font-weight="600">Why it works:</text>
        <text x="0" y="18" fill="#666">• If ε ~ N(0,1), then μ + σ·ε ~ N(μ, σ²) — same distribution!</text>
        <text x="0" y="35" fill="#666">• ε is sampled once and treated as constant during backprop</text>
        <text x="0" y="52" fill="#666">• Gradients ∂z/∂μ = 1 and ∂z/∂σ = ε flow normally</text>
      </g>
    </g>
  </g>

  <!-- Gradient flow -->
  <g transform="translate(565, 215)">
    <rect x="0" y="0" width="255" height="160" fill="white" rx="8" stroke="#7c3aed" stroke-width="2"/>
    <text x="127" y="22" fill="#7c3aed" font-family="Segoe UI, sans-serif" font-size="12" font-weight="600" text-anchor="middle">Gradient Flow</text>

    <g transform="translate(15, 45)">
      <!-- Flow diagram -->
      <rect x="0" y="0" width="70" height="30" fill="#fef2f2" rx="4"/>
      <text x="35" y="20" fill="#ef4444" font-family="Segoe UI, sans-serif" font-size="10" text-anchor="middle">Loss L</text>

      <line x1="70" y1="15" x2="95" y2="15" stroke="#666" stroke-width="1" marker-end="url(#sampArrow)"/>

      <rect x="98" y="0" width="50" height="30" fill="#d1fae5" rx="4"/>
      <text x="123" y="20" fill="#10b981" font-family="Segoe UI, sans-serif" font-size="10" text-anchor="middle">z</text>

      <line x1="148" y1="15" x2="173" y2="15" stroke="#666" stroke-width="1" marker-end="url(#sampArrow)"/>

      <rect x="176" y="0" width="50" height="30" fill="#dbeafe" rx="4"/>
      <text x="201" y="20" fill="#3b82f6" font-family="Segoe UI, sans-serif" font-size="10" text-anchor="middle">μ, σ</text>

      <!-- Gradient equations -->
      <g transform="translate(0, 50)" font-family="Consolas, monospace" font-size="9">
        <text x="0" y="0" fill="#7c3aed">∂L/∂μ = ∂L/∂z · ∂z/∂μ</text>
        <text x="0" y="18" fill="#7c3aed">       = ∂L/∂z · 1</text>

        <text x="0" y="45" fill="#10b981">∂L/∂σ = ∂L/∂z · ∂z/∂σ</text>
        <text x="0" y="63" fill="#10b981">       = ∂L/∂z · ε</text>
      </g>
    </g>
  </g>
</svg>
