<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 11: Clustering | CMSC 173</title>
    <meta name="description" content="Clustering - CMSC 173 at University of the Philippines Cebu">

    <!-- External Stylesheet -->
    <link rel="stylesheet" href="/static/css/lecture-presenter.css">

    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
</head>
<body>
    <!-- Skip Link for Accessibility -->
    <a href="#slide-content" class="skip-link">Skip to slide content</a>

    <header class="presenter-header">
        <div class="header-left">
            <a href="/course/cmsc173" class="home-button" aria-label="Return to course page">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
                Back to Course
            </a>
            <h1>Module 11: Clustering</h1>
        </div>
        <div class="slide-counter" aria-live="polite">
            <span class="slide-counter-label">Slide</span>
            <span id="current-slide">1</span> / <span id="total-slides">1</span>
        </div>
    </header>

    <main class="presentation-container">
        <div class="slide-viewer">
            <!-- Progress Bar -->
            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar-fill" id="progress-fill"></div>
            </div>

            <!-- Left Navigation Button -->
            <div class="nav-overlay nav-prev">
                <button class="nav-btn" id="prev-btn" onclick="previousSlide()" aria-label="Previous slide">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                    </svg>
                </button>
            </div>

            <!-- Slide Content -->
            <div class="slide-content" id="slide-content" tabindex="-1" aria-live="polite" aria-atomic="true">
                <div class="loading-state">
                    <p>Loading slides...</p>
                </div>
            </div>

            <!-- Right Navigation Button -->
            <div class="nav-overlay nav-next">
                <button class="nav-btn" id="next-btn" onclick="nextSlide()" aria-label="Next slide">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </button>
                <a href="/course/cmsc173/module/12" class="next-module-btn" id="next-module-btn">
                    <span>Next Module</span>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>
                </a>
            </div>

            <!-- Bottom Control Bar -->
            <div class="slide-controls-bar">
                <div class="slide-info">
                    <span class="slide-number"><span id="slide-num">1</span>/<span id="slide-total">1</span></span>
                    <span class="reading-time-inline" id="reading-time"></span>
                    <span>CMSC 173</span>
                </div>
                <div class="slide-actions">
                    <button onclick="goToSlide(0)" title="First slide">First</button>
                    <button onclick="goToSlide(slides.length - 1)" title="Last slide">Last</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Screen Reader Announcements -->
    <div id="sr-announcer" class="sr-only" aria-live="assertive" aria-atomic="true"></div>

    <script nonce="{{ csp_nonce() }}">
        let slides = [];
        let currentSlide = 0;
        let moduleInfo = null;

        async function loadSlides() {
            try {
                const response = await fetch('/static/data/courses/cmsc173/module-11-slides.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                slides = data.slides;
                moduleInfo = data.module;
                document.getElementById('total-slides').textContent = slides.length;
                document.getElementById('slide-total').textContent = slides.length;
                renderSlide();
                announceToScreenReader(`Loaded ${slides.length} slides`);
            } catch (error) {
                console.error('Failed to load slides:', error);
                showError('Failed to load lecture content. Please refresh the page.');
            }
        }

        function showError(message) {
            document.getElementById('slide-content').innerHTML = `
                <div class="warning"><strong>Error:</strong> ${message}</div>
                <p>Please try refreshing the page.</p>`;
        }

        function announceToScreenReader(message) {
            const announcer = document.getElementById('sr-announcer');
            announcer.textContent = message;
            setTimeout(() => { announcer.textContent = ''; }, 1000);
        }

        function renderSlide() {
            if (!slides.length || !slides[currentSlide]) { showError('Slide not found'); return; }
            const slide = slides[currentSlide];
            const contentDiv = document.getElementById('slide-content');
            let slideHTML = `<h2>${slide.title}</h2>${slide.content}`;
            if (slide.knowledgeCheck) {
                slideHTML += `
                    <div class="knowledge-check">
                        <h4>Knowledge Check</h4>
                        <p class="question">${slide.knowledgeCheck.question}</p>
                        <button onclick="toggleAnswer(this)" aria-expanded="false">Reveal Answer</button>
                        <div class="answer hidden" aria-hidden="true">${slide.knowledgeCheck.answer}</div>
                    </div>`;
            }
            contentDiv.innerHTML = slideHTML;
            document.getElementById('current-slide').textContent = currentSlide + 1;
            document.getElementById('slide-num').textContent = currentSlide + 1;
            document.getElementById('reading-time').textContent = slide.readingTime ? `~${slide.readingTime}` : '';
            const progress = ((currentSlide + 1) / slides.length) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
            document.getElementById('prev-btn').disabled = currentSlide === 0;
            document.getElementById('next-btn').disabled = currentSlide === slides.length - 1;
            const isLastSlide = currentSlide === slides.length - 1;
            document.getElementById('next-module-btn').classList.toggle('visible', isLastSlide);
            document.getElementById('next-btn').style.display = isLastSlide ? 'none' : 'flex';
            contentDiv.scrollTop = 0;
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(contentDiv, {
                    delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}],
                    throwOnError: false
                });
            }
            announceToScreenReader(`Slide ${currentSlide + 1} of ${slides.length}: ${slide.title}`);
        }

        function toggleAnswer(button) {
            const answerDiv = button.nextElementSibling;
            const isHidden = answerDiv.classList.contains('hidden');
            answerDiv.classList.toggle('hidden');
            answerDiv.setAttribute('aria-hidden', !isHidden);
            button.setAttribute('aria-expanded', isHidden);
            button.textContent = isHidden ? 'Hide Answer' : 'Reveal Answer';
        }

        function nextSlide() { if (currentSlide < slides.length - 1) { currentSlide++; renderSlide(); } }
        function previousSlide() { if (currentSlide > 0) { currentSlide--; renderSlide(); } }
        function goToSlide(index) { if (index >= 0 && index < slides.length) { currentSlide = index; renderSlide(); } }

        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            if (e.key === 'ArrowRight' || e.key === 'PageDown' || e.key === ' ') { e.preventDefault(); nextSlide(); }
            if (e.key === 'ArrowLeft' || e.key === 'PageUp') { e.preventDefault(); previousSlide(); }
            if (e.key === 'Home') { e.preventDefault(); goToSlide(0); }
            if (e.key === 'End') { e.preventDefault(); goToSlide(slides.length - 1); }
        });

        let touchStartX = 0;
        document.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
        document.addEventListener('touchend', (e) => {
            const diff = touchStartX - e.changedTouches[0].screenX;
            if (Math.abs(diff) > 50) { diff > 0 ? nextSlide() : previousSlide(); }
        }, { passive: true });

        document.addEventListener('DOMContentLoaded', loadSlides);
    </script>
</body>
</html>
