<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Project Portal</title>
    <style>
        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1B5E4F 0%, #2D4F47 50%, #7A1E3F 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 50px 40px;
            overflow: hidden;
        }
        h1 {
            color: #1B5E4F;
            text-align: center;
            font-size: 2.8em;
            margin-bottom: 20px;
            font-weight: 700;
        }
        h2 {
            color: #7A1E3F;
            font-size: 1.8em;
            margin-top: 40px;
            margin-bottom: 20px;
            border-bottom: 2px solid #D4AF37;
            padding-bottom: 10px;
        }
        .form-section {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        input[type="text"],
        textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        button {
            background-color: #1B5E4F;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0F3E35;
        }
        .group-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .group-card {
            background-color: #e8f5e9; /* Light green */
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .group-card h3 {
            color: #2e7d32; /* Dark green */
            margin-top: 0;
            margin-bottom: 10px;
        }
        .group-card p {
            margin-bottom: 5px;
            font-size: 0.95em;
        }
        .group-card ul {
            list-style-type: disc;
            margin-left: 20px;
            padding-left: 0;
        }
        .group-card li {
            margin-bottom: 3px;
        }
        .back-button {
            display: inline-block;
            margin-top: 30px;
            background-color: #7A1E3F;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .back-button:hover {
            background-color: #5C162F;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-button">‚Üê Back to Modules</a>
        <div style="float: right; margin-top: 20px;">
            {% if session.get('is_admin') %}
                <a href="/admin_logout" class="back-button" style="background-color: #dc3545;">Logout Admin</a>
            {% else %}
                <a href="/admin_login" class="back-button" style="background-color: #28a745;">Admin Login</a>
            {% endif %}
        </div>
        <h1>Group Project Portal</h1>

        <div class="form-section">
            <h2>Create New Group</h2>
            <form id="createGroupForm">
                <div class="form-group">
                    <label for="groupName">Group Name:</label>
                    <input type="text" id="groupName" name="group_name" required>
                </div>
                <div class="form-group">
                    <label for="projectTitle">Project Title (Optional):</label>
                    <input type="text" id="projectTitle" name="project_title">
                </div>
                <div class="form-group">
                    <label for="newMemberName">Add Group Member:</label>
                    <input type="text" id="newMemberName" placeholder="Enter member name">
                    <button type="button" id="addMemberButton">Add Member</button>
                    <div id="membersList" style="margin-top: 10px; border: 1px solid #eee; padding: 10px; border-radius: 5px; min-height: 50px;">
                        <!-- Added members will appear here -->
                        <p id="noMembersMessage" style="color: #888;">No members added yet.</p>
                    </div>
                </div>
                <button type="submit">Create Group</button>
            </form>
        </div>

        <div class="form-section">
            <h2>Existing Groups</h2>
            <div id="groupsList" class="group-list">
                <!-- Groups will be loaded here by JavaScript -->
                <p>Loading groups...</p>
            </div>
        </div>

        <!-- Document Upload Section (will be dynamically shown for a selected group) -->
        <div class="form-section" id="documentUploadSection" style="display: none;">
            <h2>Upload Document for <span id="currentGroupName"></span></h2>
            <form id="uploadDocumentForm">
                <input type="hidden" id="uploadGroupId" name="group_id">
                <div class="form-group">
                    <label for="documentTitle">Document Title:</label>
                    <input type="text" id="documentTitle" name="document_title" required>
                </div>
                <div class="form-group">
                    <label for="documentFile">Select File:</label>
                    <input type="file" id="documentFile" name="file" required>
                </div>
                <button type="submit">Upload Document</button>
            </form>
        </div>

    </div>

    <script>
        const IS_ADMIN = {{ session.get('is_admin', False) | tojson }}; // Passed from Flask backend

        document.addEventListener('DOMContentLoaded', () => {
                        const createGroupForm = document.getElementById('createGroupForm');
                        const groupsList = document.getElementById('groupsList');
                        const documentUploadSection = document.getElementById('documentUploadSection');
                        const uploadDocumentForm = document.getElementById('uploadDocumentForm');
                        const currentGroupName = document.getElementById('currentGroupName');
                        const uploadGroupId = document.getElementById('uploadGroupId');
            
                        const newMemberNameInput = document.getElementById('newMemberName');
                        const addMemberButton = document.getElementById('addMemberButton');
                        const membersListDiv = document.getElementById('membersList');
                        const noMembersMessage = document.getElementById('noMembersMessage');
            
                        let selectedGroupId = null;
                        let currentMembers = []; // Array to hold members for the new group
            
                // Function to fetch and display all groups
                async function fetchAndDisplayGroups() {
                    groupsList.innerHTML = '<p>Loading groups...</p>';
                    try {
                        const response = await fetch('/api/groups');
                        const groups = await response.json();
            
                        if (groups.error) {
                            groupsList.innerHTML = `<p style="color: red;">Error: ${groups.error}</p>`;
                            return;
                        }
            
                        if (groups.length === 0) {
                            groupsList.innerHTML = '<p>No groups created yet.</p>';
                            return;
                        }
            
                        groupsList.innerHTML = '';
                        groups.forEach(group => {
                            const groupCard = document.createElement('div');
                            groupCard.className = 'group-card';
                            groupCard.innerHTML = `
                                <h3>${group.group_name}</h3>
                                <p><strong>Project Title:</strong> ${group.project_title || 'N/A'}</p>
                                <p><strong>Created:</strong> ${new Date(group.created_at).toLocaleString()}</p>
                                <button class="view-details-btn" data-group-id="${group.id}">View Details</button>
                            `;
                            groupsList.appendChild(groupCard);
                        });
            
                        document.querySelectorAll('.view-details-btn').forEach(button => {
                            button.addEventListener('click', (event) => {
                                selectedGroupId = event.target.dataset.groupId;
                                fetchAndDisplayGroupDetails(selectedGroupId);
                            });
                        });
            
                    } catch (error) {
                        groupsList.innerHTML = `<p style="color: red;">Failed to load groups: ${error.message}</p>`;
                        console.error('Error fetching groups:', error);
                    }
                }
            
                // Function to fetch and display details for a single group
                async function fetchAndDisplayGroupDetails(groupId) {
                    try {
                        const response = await fetch(`/api/groups/${groupId}`);
                        const group = await response.json();
            
                        if (group.error) {
                            alert(`Error: ${group.error}`);
                            return;
                        }
            
                        // Update the selected group's card with details
                        const groupCard = document.querySelector(`.group-card button[data-group-id="${groupId}"]`).closest('.group-card');
                        if (groupCard) {
                            groupCard.innerHTML = `
                                <h3>${group.group_name}</h3>
                                <p><strong>Project Title:</strong> ${group.project_title || 'N/A'}</p>
                                <p><strong>Created:</strong> ${new Date(group.created_at).toLocaleString()}</p>
                                <h4>Members:</h4>
                                <ul>
                                    ${group.members.map(member => `<li>${member.member_name}</li>`).join('')}
                                </ul>
                                <h4>Documents:</h4>
                                <ul>
                                    ${group.documents.map(doc => `<li><a href="/uploads/${doc.file_path.split('/').pop()}" target="_blank">${doc.document_title}</a></li>`).join('')}
                                </ul>
                                                    <button class="upload-doc-btn" data-group-id="${group.id}" data-group-name="${group.group_name}">Upload Document</button>
                                                    ${IS_ADMIN ? `<button class="delete-group-btn" data-group-id="${group.id}" style="background-color: #dc3545; margin-left: 10px;">Delete Group</button>` : ''}
                                                    <button class="hide-details-btn" data-group-id="${group.id}">Hide Details</button>                            `;
            
                            document.querySelector(`.group-card button[data-group-id="${groupId}"].upload-doc-btn`).addEventListener('click', (event) => {
                                selectedGroupId = event.target.dataset.groupId;
                                currentGroupName.textContent = event.target.dataset.groupName;
                                uploadGroupId.value = selectedGroupId;
                                documentUploadSection.style.display = 'block';
                                documentUploadSection.scrollIntoView({ behavior: 'smooth' });
                            });
            
                                            document.querySelector(`.group-card button[data-group-id="${groupId}"].hide-details-btn`).addEventListener('click', () => {
                                                fetchAndDisplayGroups(); // Re-render all groups to hide details
                                                documentUploadSection.style.display = 'none';
                                            });
                            
                                            if (IS_ADMIN) {
                                                document.querySelector(`.group-card button[data-group-id="${groupId}"].delete-group-btn`).addEventListener('click', async () => {
                                                    if (confirm('Are you sure you want to delete this group and all its associated data?')) {
                                                        try {
                                                            const response = await fetch(`/api/groups/${groupId}`, {
                                                                method: 'DELETE',
                                                                headers: {
                                                                    'Content-Type': 'application/json',
                                                                },
                                                            });
                                                            const result = await response.json();
                            
                                                            if (result.error) {
                                                                alert(`Error deleting group: ${result.error}`);
                                                            } else {
                                                                alert('Group deleted successfully!');
                                                                fetchAndDisplayGroups(); // Refresh the list of groups
                                                                documentUploadSection.style.display = 'none';
                                                            }
                                                        } catch (error) {
                                                            alert(`Failed to delete group: ${error.message}`);
                                                            console.error('Error deleting group:', error);
                                                        }
                                                    }
                                                });
                                            }
                                        }
                            
                                    } catch (error) {
                                        alert(`Failed to load group details: ${error.message}`);
                                        console.error('Error fetching group details:', error);
                                    }
                                }            
            
                    // Handle adding members
                    addMemberButton.addEventListener('click', () => {
                        const memberName = newMemberNameInput.value.trim();
                        if (memberName) {
                            currentMembers.push(memberName);
                            console.log('Current Members:', currentMembers); // Debugging line
                            renderCurrentMembers();
                            newMemberNameInput.value = '';
                        }
                    });
            
                    function renderCurrentMembers() {
                        membersListDiv.innerHTML = ''; // Clear previous list
                        if (currentMembers.length === 0) {
                            membersListDiv.innerHTML = '<p id="noMembersMessage" style="color: #888;">No members added yet.</p>';
                        } else {
                            const ul = document.createElement('ul');
                            currentMembers.forEach((member, index) => {
                                const li = document.createElement('li');
                                li.textContent = member;
                                const removeButton = document.createElement('button');
                                removeButton.textContent = 'Remove';
                                removeButton.style.marginLeft = '10px';
                                removeButton.style.backgroundColor = '#dc3545';
                                removeButton.style.padding = '5px 10px';
                                removeButton.addEventListener('click', () => {
                                    currentMembers.splice(index, 1);
                                    renderCurrentMembers();
                                });
                                li.appendChild(removeButton);
                                ul.appendChild(li);
                            });
                            membersListDiv.appendChild(ul);
                        }
                    }
            
                    // Handle create group form submission
                    createGroupForm.addEventListener('submit', async (event) => {
                        event.preventDefault();
                        const formData = new FormData(createGroupForm);
                        const groupName = formData.get('group_name');
                        const projectTitle = formData.get('project_title');
                        // Use currentMembers array instead of parsing from textarea
            
                        if (!groupName) {
                            alert('Group Name is required.');
                            return;
                        }
                            try {
                                const response = await fetch('/api/groups', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ group_name: groupName, project_title: projectTitle, members: currentMembers }),
                                });
                                const result = await response.json();
                
                                if (result.error) {
                                    alert(`Error creating group: ${result.error}`);
                                } else {
                                    alert('Group created successfully!');
                                    createGroupForm.reset();
                                    currentMembers = []; // Clear members array
                                    renderCurrentMembers(); // Update display
                                    fetchAndDisplayGroups(); // Refresh the list of groups
                                }
                            } catch (error) {
                                alert(`Failed to create group: ${error.message}`);
                                console.error('Error creating group:', error);
                            }
                        });
            // Handle document upload form submission
            uploadDocumentForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!selectedGroupId) {
                    alert('Please select a group first.');
                    return;
                }

                const formData = new FormData(uploadDocumentForm);
                formData.append('group_id', selectedGroupId); // Ensure group_id is in form data

                try {
                    const response = await fetch(`/api/groups/${selectedGroupId}/documents`, {
                        method: 'POST',
                        body: formData, // FormData handles Content-Type automatically
                    });
                    const result = await response.json();

                    if (result.error) {
                        alert(`Error uploading document: ${result.error}`);
                    } else {
                        alert('Document uploaded successfully!');
                        uploadDocumentForm.reset();
                        documentUploadSection.style.display = 'none'; // Hide upload section
                        fetchAndDisplayGroupDetails(selectedGroupId); // Refresh group details
                    }
                } catch (error) {
                    alert(`Failed to upload document: ${error.message}`);
                    console.error('Error uploading document:', error);
                }
            });

            // Initial fetch of groups when the page loads
            fetchAndDisplayGroups();
        });
    </script>
</body>
</html>
