<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Project Portal</title>
    <style>
        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1B5E4F 0%, #2D4F47 50%, #7A1E3F 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 50px 40px;
            overflow: hidden;
        }
        h1 {
            color: #1B5E4F;
            text-align: center;
            font-size: 2.8em;
            margin-bottom: 20px;
            font-weight: 700;
        }
        h2 {
            color: #7A1E3F;
            font-size: 1.8em;
            margin-top: 40px;
            margin-bottom: 20px;
            border-bottom: 2px solid #D4AF37;
            padding-bottom: 10px;
        }
        .form-section {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        input[type="text"],
        textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        button {
            background-color: #1B5E4F;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0F3E35;
        }
        .group-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .group-card {
            background-color: #e8f5e9; /* Light green */
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .group-card h3 {
            color: #2e7d32; /* Dark green */
            margin-top: 0;
            margin-bottom: 10px;
        }
        .group-card p {
            margin-bottom: 5px;
            font-size: 0.95em;
        }
        .group-card ul {
            list-style-type: disc;
            margin-left: 20px;
            padding-left: 0;
        }
        .group-card li {
            margin-bottom: 3px;
        }
        .back-button {
            display: inline-block;
            margin-top: 30px;
            background-color: #7A1E3F;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .back-button:hover {
            background-color: #5C162F;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-button">‚Üê Back to Homepage</a>
        <div style="float: right; margin-top: 20px;">
            {% if session.get('is_admin') %}
                <a href="/admin_logout" class="back-button" style="background-color: #dc3545;">Logout Admin</a>
            {% else %}
                <a href="/admin_login" class="back-button" style="background-color: #28a745;">Admin Login</a>
            {% endif %}
        </div>
        <h1>Group Project Portal</h1>

        <div style="text-align: center; margin-bottom: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <button id="showCreateGroupBtn" class="back-button" style="background-color: #1B5E4F; font-size: 1.1em; padding: 12px 30px;">
                + Create New Group
            </button>
            <a href="/group_login" class="back-button" style="background-color: #7A1E3F; font-size: 1.1em; padding: 12px 30px; text-decoration: none; display: inline-block;">
                üîê Group Login
            </a>
        </div>

        <div class="form-section" id="createGroupSection" style="display: none;">
            <h2 style="margin-bottom: 25px;">Create New Group</h2>
            <form id="createGroupForm">
                <!-- Group Info Section -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #1B5E4F;">
                    <h3 style="margin: 0 0 15px 0; color: #1B5E4F; font-size: 16px; font-weight: 600;">üìã Group Information</h3>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label for="groupName" style="font-weight: 500; color: #333; margin-bottom: 5px; display: block;">Group Name</label>
                        <input type="text" id="groupName" name="group_name" required
                               placeholder="e.g., Team Alpha, The Innovators"
                               style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px; transition: all 0.2s;"
                               onfocus="this.style.borderColor='#1B5E4F'; this.style.boxShadow='0 0 0 3px rgba(27,94,79,0.1)'"
                               onblur="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="projectTitle" style="font-weight: 500; color: #333; margin-bottom: 5px; display: block;">Project Title</label>
                        <input type="text" id="projectTitle" name="project_title" required
                               placeholder="e.g., Machine Learning Image Classifier"
                               style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px; transition: all 0.2s;"
                               onfocus="this.style.borderColor='#1B5E4F'; this.style.boxShadow='0 0 0 3px rgba(27,94,79,0.1)'"
                               onblur="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                    </div>
                </div>

                <!-- Login Credentials Section -->
                <div style="background: #f8e8e8; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #8B0000;">
                    <h3 style="margin: 0 0 15px 0; color: #5c0000; font-size: 16px; font-weight: 600;">üîê Login Credentials</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="groupUsername" style="font-weight: 500; color: #333; margin-bottom: 5px; display: block;">Username</label>
                            <input type="text" id="groupUsername" name="username" required
                                   placeholder="Choose a unique username"
                                   style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px; transition: all 0.2s;"
                                   onfocus="this.style.borderColor='#8B0000'; this.style.boxShadow='0 0 0 3px rgba(139,0,0,0.1)'"
                                   onblur="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="groupPassword" style="font-weight: 500; color: #333; margin-bottom: 5px; display: block;">Password</label>
                            <input type="password" id="groupPassword" name="password" minlength="6" required
                                   placeholder="Min 6 characters"
                                   style="width: 100%; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px; transition: all 0.2s;"
                                   onfocus="this.style.borderColor='#8B0000'; this.style.boxShadow='0 0 0 3px rgba(139,0,0,0.1)'"
                                   onblur="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
                        </div>
                    </div>
                </div>

                <!-- Members Section -->
                <div style="background: #e8f4e8; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #1B5E4F;">
                    <h3 style="margin: 0 0 15px 0; color: #1B5E4F; font-size: 16px; font-weight: 600;">üë• Group Members</h3>
                    <div style="position: relative; margin-bottom: 15px;">
                        <input type="text" id="studentSearch" placeholder="üîç Search students by name or campus ID..."
                               style="width: 100%; padding: 12px 15px; border: 2px solid #d4e6d4; border-radius: 8px; font-size: 14px; background: white; transition: all 0.2s;"
                               onfocus="this.style.borderColor='#1B5E4F'; this.style.boxShadow='0 0 0 3px rgba(27,94,79,0.1)'; this.placeholder='Start typing to search...'"
                               onblur="this.style.borderColor='#d4e6d4'; this.style.boxShadow='none'; this.placeholder='üîç Search students by name or campus ID...'">
                        <input type="hidden" id="selectedStudentId">
                        <ul id="studentsList" style="display: none; list-style: none; margin: 0; padding: 0; max-height: 300px; overflow-y: auto; border: 2px solid #1B5E4F; border-radius: 8px; background: white; position: absolute; width: 100%; z-index: 100; box-shadow: 0 8px 16px rgba(0,0,0,0.15); margin-top: 5px;"></ul>
                    </div>
                    <div id="selectedMembers" style="min-height: 50px; border: 2px dashed #d4e6d4; padding: 15px; border-radius: 8px; background: white;">
                        <p id="noMembersMsg" style="color: #6c757d; margin: 0; text-align: center; font-style: italic;">No members added yet. Search above to add students.</p>
                    </div>
                    <div id="classAlert" style="margin-top: 15px; padding: 12px; background: #e8f4e8; border-radius: 6px; border-left: 4px solid #1B5E4F; display: none;">
                        <small id="classAlertText" style="color: #1B5E4F; font-weight: 500;"></small>
                    </div>
                </div>

                <button type="submit" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #1B5E4F 0%, #2D4F47 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'">
                    ‚ú® Create Group
                </button>
            </form>
        </div>

        <div class="form-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Existing Groups</h2>
                <div style="display: flex; gap: 8px; background: #f8f9fa; padding: 4px; border-radius: 8px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);">
                    <button id="viewKanban" class="view-toggle" style="padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s; background: transparent; color: #6c757d;">
                        üìä Cards
                    </button>
                    <button id="viewList" class="view-toggle active" style="padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s; background: white; color: #7A1E3F; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        üìã List
                    </button>
                </div>
            </div>
            <div id="groupsList" class="group-list">
                <!-- Groups will be loaded here by JavaScript -->
                <p>Loading groups...</p>
            </div>
        </div>

        <!-- Document Upload Section (will be dynamically shown for a selected group) -->
        <div class="form-section" id="documentUploadSection" style="display: none;">
            <h2>Upload Document for <span id="currentGroupName"></span></h2>
            <form id="uploadDocumentForm">
                <input type="hidden" id="uploadGroupId" name="group_id">
                <div class="form-group">
                    <label for="documentTitle">Document Title:</label>
                    <input type="text" id="documentTitle" name="document_title" required>
                </div>
                <div class="form-group">
                    <label for="documentFile">Select File:</label>
                    <input type="file" id="documentFile" name="file" required>
                </div>
                <button type="submit">Upload Document</button>
            </form>
        </div>
        
        <!-- Group Details Modal -->
        <div id="groupDetailsModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px);">
            <div class="modal-content" style="background-color: #fff; margin: 5% auto; padding: 30px; border: none; width: 90%; max-width: 600px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideIn 0.3s ease-out;">
                <span class="close-modal" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s;">&times;</span>
                <h2 id="modalGroupName" style="margin-top: 0; color: #1B5E4F; border-bottom: 2px solid #D4AF37; padding-bottom: 15px; margin-bottom: 20px;">Group Details</h2>
                <div id="modalContent">
                    <p>Loading...</p>
                </div>
            </div>
        </div>
        <style>
            @keyframes slideIn {
                from {transform: translateY(-20px); opacity: 0;}
                to {transform: translateY(0); opacity: 1;}
            }
            .close-modal:hover { color: #333; }
        </style>

    </div>

    <script>
        const IS_ADMIN = {{ session.get('is_admin', False) | tojson }}; // Passed from Flask backend

        document.addEventListener('DOMContentLoaded', () => {
                        console.log('DOMContentLoaded event fired!');
                        const createGroupForm = document.getElementById('createGroupForm');
                        const createGroupSection = document.getElementById('createGroupSection');
                        const showCreateGroupBtn = document.getElementById('showCreateGroupBtn');

                        // Toggle create group form visibility
                        showCreateGroupBtn.addEventListener('click', () => {
                            if (createGroupSection.style.display === 'none') {
                                createGroupSection.style.display = 'block';
                                showCreateGroupBtn.textContent = '‚àí Hide Form';
                                createGroupSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            } else {
                                createGroupSection.style.display = 'none';
                                showCreateGroupBtn.textContent = '+ Create New Group';
                            }
                        });
                        const groupsList = document.getElementById('groupsList');
                        const documentUploadSection = document.getElementById('documentUploadSection');
                        const uploadDocumentForm = document.getElementById('uploadDocumentForm');
                        const currentGroupName = document.getElementById('currentGroupName');
                        const uploadGroupId = document.getElementById('uploadGroupId');
                        
                        // Modal elements
                        const modal = document.getElementById('groupDetailsModal');
                        const closeModal = document.querySelector('.close-modal');

                        closeModal.onclick = function() {
                            modal.style.display = "none";
                        }

                        window.onclick = function(event) {
                            if (event.target == modal) {
                                modal.style.display = "none";
                            }
                        }

                        const studentSearch = document.getElementById('studentSearch');
                        const selectedStudentIdHidden = document.getElementById('selectedStudentId');
                        const studentsList = document.getElementById('studentsList');
                        const selectedMembers = document.getElementById('selectedMembers');
                        const noMembersMsg = document.getElementById('noMembersMsg');
                        const classAlert = document.getElementById('classAlert');
                        const classAlertText = document.getElementById('classAlertText');

                        let selectedGroupId = null;
                        let currentMembers = []; // Array to hold members for the new group
                        let availableStudents = []; // Array to hold all ungrouped students
                        let currentView = 'list'; // Default view updated to LIST
                        let cachedGroups = []; // Cache groups data

                        // Load all ungrouped students from all classes
                        async function loadAllStudents() {
                            try {
                                console.log('Loading all ungrouped students from all classes');
                                const response = await fetch('/api/students/ungrouped/all');
                                console.log('Response status:', response.status, response.statusText);

                                if (!response.ok) {
                                    throw new Error('Failed to fetch students');
                                }

                                const students = await response.json();
                                console.log('Received students:', students);

                                availableStudents = students;
                                console.log('Available students:', availableStudents);
                                console.log('Number of available students:', availableStudents.length);

                                // Log first student structure for debugging
                                if (availableStudents.length > 0) {
                                    console.log('First student structure:', availableStudents[0]);
                                    console.log('First student name parts:', {
                                        id: availableStudents[0].id,
                                        first_name: availableStudents[0].first_name,
                                        last_name: availableStudents[0].last_name,
                                        campus_id: availableStudents[0].campus_id,
                                        program: availableStudents[0].program
                                    });
                                }

                                const ungroupedCount = students.length;
                                if (ungroupedCount > 0) {
                                    classAlert.style.display = 'block';
                                    classAlertText.textContent = `${ungroupedCount} ungrouped students available across all sections`;
                                } else {
                                    classAlert.style.display = 'block';
                                    classAlertText.textContent = 'No ungrouped students available';
                                }
                            } catch (error) {
                                console.error('Error loading students:', error);
                                classAlert.style.display = 'block';
                                classAlertText.textContent = '‚ùå Error loading students: ' + error.message;
                            }
                        }

                        // Filter and display students in dropdown
                        function filterStudents(searchTerm) {
                            console.log('Filtering students with search term:', searchTerm);
                            console.log('Available students count:', availableStudents.length);

                            studentsList.innerHTML = '';
                            const searchLower = searchTerm.toLowerCase();

                            // Filter students based on search term
                            const filtered = availableStudents.filter(student => {
                                if (!searchTerm.trim()) return true; // Show all if empty search
                                const firstName = student.first_name || '';
                                const lastName = student.last_name || '';
                                const fullName = `${firstName} ${lastName}`.toLowerCase();
                                const campusId = (student.campus_id || '').toLowerCase();
                                return fullName.includes(searchLower) || campusId.includes(searchLower);
                            });

                            console.log('Filtered students count:', filtered.length);

                            // Hide dropdown if no students available
                            if (filtered.length === 0) {
                                const li = document.createElement('li');
                                li.textContent = 'No students found';
                                li.style.padding = '10px';
                                li.style.color = '#999';
                                studentsList.appendChild(li);
                                studentsList.style.display = 'block';
                                return;
                            }

                            filtered.forEach((student, index) => {
                                const firstName = student.first_name || '';
                                const lastName = student.last_name || '';
                                const fullName = `${firstName} ${lastName}`.trim() || 'Unnamed Student';
                                const campusId = student.campus_id || 'No ID';
                                const program = student.program || 'N/A';

                                if (index < 3) { // Log first 3 students for debugging
                                    console.log(`Student ${index}:`, {
                                        first_name: firstName,
                                        last_name: lastName,
                                        fullName: fullName,
                                        campus_id: campusId,
                                        program: program
                                    });
                                }

                                const li = document.createElement('li');
                                li.innerHTML = `<strong>${fullName}</strong><br><small>${campusId} - ${program}</small>`;
                                li.style.padding = '10px';
                                li.style.borderBottom = '1px solid #eee';
                                li.style.cursor = 'pointer';
                                li.style.backgroundColor = '#fff';
                                li.addEventListener('mouseenter', () => {
                                    li.style.backgroundColor = '#f0f0f0';
                                });
                                li.addEventListener('mouseleave', () => {
                                    li.style.backgroundColor = '#fff';
                                });
                                li.addEventListener('click', () => {
                                    // Check if student is already added
                                    if (currentMembers.some(m => m.studentId === student.id)) {
                                        alert(`${fullName} is already in the group!`);
                                        return;
                                    }

                                    // Add the student to the group
                                    const studentData = {
                                        studentId: student.id,
                                        name: fullName,
                                        campusId: student.campus_id
                                    };

                                    currentMembers.push(studentData);
                                    renderCurrentMembers();

                                    // Clear search and hide dropdown
                                    studentSearch.value = '';
                                    studentsList.style.display = 'none';

                                    console.log('Added student to group:', studentData);
                                });
                                studentsList.appendChild(li);
                            });

                            studentsList.style.display = 'block';
                            console.log('Dropdown populated with', filtered.length, 'students');
                        }

                    // Show dropdown when search box is focused
                    studentSearch.addEventListener('focus', () => {
                        if (availableStudents.length > 0) {
                            filterStudents(studentSearch.value);
                        }
                    });

                    // Filter as user types
                    studentSearch.addEventListener('input', (e) => {
                        const searchTerm = e.target.value;
                        if (availableStudents.length > 0) {
                            filterStudents(searchTerm);
                        }
                    });

                    // Hide dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!studentSearch.contains(e.target) && !studentsList.contains(e.target)) {
                            studentsList.style.display = 'none';
                        }
                    });

                // Function to render groups in the selected view
                function renderGroups(groups, view) {
                    groupsList.innerHTML = '';

                    if (view === 'kanban') {
                        // Kanban/Card View
                        groups.forEach(group => {
                            const groupCard = document.createElement('div');
                            groupCard.className = 'group-card';
                            const memberCount = group.group_members ? group.group_members.length : 0;

                            // Get member last names only
                            let memberNames = '';
                            if (group.group_members && group.group_members.length > 0) {
                                const names = group.group_members.map(m => {
                                    if (!m.member_name) return null;
                                    // Extract last name (first word in full name for Filipino naming convention)
                                    const parts = m.member_name.trim().split(' ');
                                    return parts[0]; // First word is usually the last name
                                }).filter(n => n);
                                if (names.length > 0) {
                                    memberNames = `<p style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #7A1E3F;"><strong>üë• Team:</strong><br><span style="font-size: 14px; color: #495057;">${names.join(', ')}</span></p>`;
                                }
                            }

                            groupCard.innerHTML = `
                                <h3>${group.group_name}</h3>
                                <p><strong>Project:</strong> ${group.project_title || 'N/A'}</p>
                                <p><strong>Members:</strong> ${memberCount}</p>
                                ${memberNames}
                                <p><strong>Created:</strong> ${new Date(group.created_at).toLocaleDateString()}</p>
                                <button class="view-details-btn" data-group-id="${group.id}">View Details</button>
                            `;
                            groupsList.appendChild(groupCard);
                        });
                    } else {
                        // List View
                        const table = document.createElement('table');
                        table.style.cssText = 'width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';

                        table.innerHTML = `
                            <thead>
                                <tr style="background: linear-gradient(135deg, #1B5E4F 0%, #2D4F47 100%); color: white;">
                                    <th style="padding: 15px; text-align: left; font-weight: 600;">Group Name</th>
                                    <th style="padding: 15px; text-align: left; font-weight: 600;">Project Title</th>
                                    <th style="padding: 15px; text-align: left; font-weight: 600;">Created</th>
                                    <th style="padding: 15px; text-align: center; font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="groupsTableBody"></tbody>
                        `;

                        const tbody = table.querySelector('#groupsTableBody');
                        groups.forEach((group, index) => {
                            // Get member names for display under group name
                            let memberNamesSubtext = '';
                            if (group.group_members && group.group_members.length > 0) {
                                const memberNames = group.group_members.map(m => {
                                    // Priority: 1) last_name field, 2) extract from member_name, 3) use full member_name as fallback
                                    if (m.last_name && m.last_name.trim()) {
                                        return m.last_name;
                                    } else if (m.member_name && m.member_name.trim()) {
                                        const parts = m.member_name.trim().split(' ');
                                        // If more than one word, use last word (surname)
                                        // Otherwise use the whole name
                                        return parts.length > 1 ? parts[parts.length - 1] : m.member_name;
                                    }
                                    return null;
                                }).filter(n => n);
                                if (memberNames.length > 0) {
                                    memberNamesSubtext = `<div style="font-size: 12px; color: #6c757d; font-weight: normal; margin-top: 4px;">
                                        ${memberNames.join(', ')}
                                    </div>`;
                                }
                            }

                            const row = document.createElement('tr');
                            row.style.cssText = `background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; transition: all 0.2s;`;
                            row.onmouseenter = () => {
                                row.style.background = '#e8f4e8';
                                row.style.transform = 'scale(1.01)';
                            };
                            row.onmouseleave = () => {
                                row.style.background = index % 2 === 0 ? '#f8f9fa' : 'white';
                                row.style.transform = 'scale(1)';
                            };

                            row.innerHTML = `
                                <td style="padding: 15px;">
                                    <div style="font-weight: 600; color: #1B5E4F;">${group.group_name}</div>
                                    ${memberNamesSubtext}
                                </td>
                                <td style="padding: 15px; color: #495057;">${group.project_title || '<em style="color: #999;">Not specified</em>'}</td>
                                <td style="padding: 15px; color: #6c757d; font-size: 14px;">${new Date(group.created_at).toLocaleDateString()}</td>
                                <td style="padding: 15px; text-align: center;">
                                    <button class="view-details-btn" data-group-id="${group.id}"
                                            style="background: linear-gradient(135deg, #1B5E4F 0%, #164636 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s;"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.2)'"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        View Details
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });

                        groupsList.appendChild(table);
                    }

                    // Attach event listeners to view details buttons
                    document.querySelectorAll('.view-details-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            selectedGroupId = event.target.dataset.groupId;
                            fetchAndDisplayGroupDetails(selectedGroupId);
                        });
                    });
                }

                // Function to fetch and display all groups
                async function fetchAndDisplayGroups() {
                    groupsList.innerHTML = '<p>Loading groups...</p>';
                    try {
                        const response = await fetch('/api/groups');
                        const groups = await response.json();

                        if (groups.error) {
                            groupsList.innerHTML = `<p style="color: red;">Error: ${groups.error}</p>`;
                            return;
                        }

                        if (groups.length === 0) {
                            groupsList.innerHTML = '<p>No groups created yet.</p>';
                            return;
                        }

                        cachedGroups = groups; // Cache the groups
                        renderGroups(groups, currentView);

                    } catch (error) {
                        groupsList.innerHTML = `<p style="color: red;">Failed to load groups: ${error.message}</p>`;
                        console.error('Error fetching groups:', error);
                    }
                }
            
                // Function to fetch and display details for a single group in a modal
                async function fetchAndDisplayGroupDetails(groupId) {
                    try {
                        const response = await fetch(`/api/groups/${groupId}`);
                        const group = await response.json();

                        if (group.error) {
                            alert(`Error: ${group.error}`);
                            return;
                        }

                        // Populate Modal
                        document.getElementById('modalGroupName').textContent = group.group_name;
                        const modalContent = document.getElementById('modalContent');
                        
                        let summaryHtml = '<p><em>No summary submitted yet.</em></p>';
                        
                        if (group.submissions && group.submissions.length > 0) {
                             // Sort by stage number descending to get latest
                             const sortedSubmissions = group.submissions.sort((a, b) => b.stage_number - a.stage_number);
                             const latestSubmission = sortedSubmissions[0];
                             
                             if (latestSubmission.summary_markdown) {
                                 // Simple markdown rendering
                                 let summaryText = latestSubmission.summary_markdown
                                    .replace(/\n/g, '<br>')
                                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                                 
                                 summaryHtml = `
                                    <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 5px solid #1B5E4F; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                                        <h4 style="margin-top: 0; color: #555; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px;">Latest Summary (Stage ${latestSubmission.stage_number})</h4>
                                        <div style="line-height: 1.6; color: #333; font-size: 1.05em;">${summaryText}</div>
                                        ${latestSubmission.presentation_link ? `<p style="margin-top: 15px;"><a href="${latestSubmission.presentation_link}" target="_blank" style="color: #1B5E4F; font-weight: bold; text-decoration: none;">üîó View Presentation</a></p>` : ''}
                                    </div>
                                 `;
                             }
                        }

                        modalContent.innerHTML = `
                            <p style="font-size: 1.1em; margin-bottom: 20px;"><strong>Project:</strong> ${group.project_title || 'N/A'}</p>
                            <h3 style="color: #1B5E4F; font-size: 1.3em; margin-bottom: 15px;">Project Summary</h3>
                            ${summaryHtml}
                        `;

                        // Show the modal
                        modal.style.display = "block";
                        
                    } catch (error) {
                        alert(`Failed to load group details: ${error.message}`);
                        console.error('Error fetching group details:', error);
                    }
                }            
            
                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (e.target !== memberDisplay && e.target !== memberSearchBox && e.target !== studentsList) {
                            studentsList.style.display = 'none';
                        }
                    });

            
                    function renderCurrentMembers() {
                        selectedMembers.innerHTML = ''; // Clear previous list
                        if (currentMembers.length === 0) {
                            selectedMembers.innerHTML = '<p id="noMembersMsg" style="color: #6c757d; margin: 0; text-align: center; font-style: italic;">No members added yet. Search above to add students.</p>';
                        } else {
                            const container = document.createElement('div');
                            container.style.display = 'grid';
                            container.style.gap = '10px';

                            currentMembers.forEach((member, index) => {
                                const card = document.createElement('div');
                                card.style.cssText = `
                                    display: flex;
                                    align-items: center;
                                    justify-content: space-between;
                                    padding: 12px 15px;
                                    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
                                    border: 2px solid #dee2e6;
                                    border-radius: 8px;
                                    transition: all 0.2s;
                                `;
                                card.onmouseenter = () => {
                                    card.style.borderColor = '#1B5E4F';
                                    card.style.boxShadow = '0 2px 8px rgba(23,162,184,0.15)';
                                };
                                card.onmouseleave = () => {
                                    card.style.borderColor = '#dee2e6';
                                    card.style.boxShadow = 'none';
                                };

                                const memberInfo = document.createElement('div');
                                memberInfo.style.flex = '1';

                                const name = document.createElement('div');
                                name.textContent = member.name;
                                name.style.cssText = 'font-weight: 600; color: #1B5E4F; margin-bottom: 3px;';

                                const campusId = document.createElement('div');
                                campusId.textContent = `üìã ${member.campusId}`;
                                campusId.style.cssText = 'font-size: 12px; color: #6c757d;';

                                memberInfo.appendChild(name);
                                memberInfo.appendChild(campusId);

                                const removeButton = document.createElement('button');
                                removeButton.innerHTML = '‚úï';
                                removeButton.style.cssText = `
                                    background: #dc3545;
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 28px;
                                    height: 28px;
                                    font-size: 16px;
                                    cursor: pointer;
                                    transition: all 0.2s;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                `;
                                removeButton.onmouseenter = () => {
                                    removeButton.style.background = '#c82333';
                                    removeButton.style.transform = 'scale(1.1)';
                                };
                                removeButton.onmouseleave = () => {
                                    removeButton.style.background = '#dc3545';
                                    removeButton.style.transform = 'scale(1)';
                                };
                                removeButton.onclick = () => {
                                    currentMembers.splice(index, 1);
                                    renderCurrentMembers();
                                };

                                card.appendChild(memberInfo);
                                card.appendChild(removeButton);
                                container.appendChild(card);
                            });
                            selectedMembers.appendChild(container);
                        }
                    }
            
                    // Handle create group form submission
                    createGroupForm.addEventListener('submit', async (event) => {
                        event.preventDefault();
                        const formData = new FormData(createGroupForm);
                        const groupName = formData.get('group_name');
                        const projectTitle = formData.get('project_title');
                        const username = formData.get('username');
                        const password = formData.get('password');

                        if (!groupName) {
                            alert('Group Name is required.');
                            return;
                        }
                        if (!username) {
                            alert('Group Username is required.');
                            return;
                        }
                        if (!password || password.length < 6) {
                            alert('Password must be at least 6 characters.');
                            return;
                        }

                        // Extract member names from currentMembers and convert to student IDs
                        const memberIds = currentMembers.map(m => m.studentId);

                            try {
                                const response = await fetch('/api/groups', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        group_name: groupName,
                                        project_title: projectTitle,
                                        username: username,
                                        password: password,
                                        members: memberIds
                                    }),
                                });
                                const result = await response.json();
                
                                if (result.error) {
                                    alert(`Error creating group: ${result.error}`);
                                } else {
                                    alert('Group created successfully!');
                                    createGroupForm.reset();
                                    currentMembers = []; // Clear members array
                                    renderCurrentMembers(); // Update display
                                    fetchAndDisplayGroups(); // Refresh the list of groups
                                }
                            } catch (error) {
                                alert(`Failed to create group: ${error.message}`);
                                console.error('Error creating group:', error);
                            }
                        });
            // Handle document upload form submission
            uploadDocumentForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!selectedGroupId) {
                    alert('Please select a group first.');
                    return;
                }

                const formData = new FormData(uploadDocumentForm);
                formData.append('group_id', selectedGroupId); // Ensure group_id is in form data

                try {
                    const response = await fetch(`/api/groups/${selectedGroupId}/documents`, {
                        method: 'POST',
                        body: formData, // FormData handles Content-Type automatically
                    });
                    const result = await response.json();

                    if (result.error) {
                        alert(`Error uploading document: ${result.error}`);
                    } else {
                        alert('Document uploaded successfully!');
                        uploadDocumentForm.reset();
                        documentUploadSection.style.display = 'none'; // Hide upload section
                        fetchAndDisplayGroupDetails(selectedGroupId); // Refresh group details
                    }
                } catch (error) {
                    alert(`Failed to upload document: ${error.message}`);
                    console.error('Error uploading document:', error);
                }
            });

            // Initial fetch of groups when the page loads
            fetchAndDisplayGroups();

            // View toggle functionality
            const viewKanbanBtn = document.getElementById('viewKanban');
            const viewListBtn = document.getElementById('viewList');

            viewKanbanBtn.addEventListener('click', () => {
                currentView = 'kanban';
                viewKanbanBtn.style.background = 'white';
                viewKanbanBtn.style.color = '#7A1E3F';
                viewKanbanBtn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                viewListBtn.style.background = 'transparent';
                viewListBtn.style.color = '#6c757d';
                viewListBtn.style.boxShadow = 'none';
                renderGroups(cachedGroups, currentView);
            });

            viewListBtn.addEventListener('click', () => {
                currentView = 'list';
                viewListBtn.style.background = 'white';
                viewListBtn.style.color = '#7A1E3F';
                viewListBtn.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                viewKanbanBtn.style.background = 'transparent';
                viewKanbanBtn.style.color = '#6c757d';
                viewKanbanBtn.style.boxShadow = 'none';
                renderGroups(cachedGroups, currentView);
            });

            // Load all students for member selection
            console.log('About to call loadAllStudents()...');
            loadAllStudents();
            console.log('loadAllStudents() called');
        });
    </script>
</body>
</html>
