{% extends "base_layout.html" %}

{% block title %}All Submissions - CMSC 173{% endblock %}

{% block extra_css %}
<style>
    /* Submissions Page-Specific Styles */

    /* Page Header */
    .page-title { color: var(--up-green); font-size: 1.6em; margin-bottom: 8px; }
    .page-subtitle { color: var(--text-secondary); font-size: 0.95em; margin-bottom: 24px; }

    /* Filter Panel */
    .filter-panel { background: var(--bg-white); padding: 24px; border-radius: var(--radius-lg); margin-bottom: 24px; box-shadow: var(--shadow); border: 1px solid var(--border); }
    .filter-panel h2 { font-size: 1.1em; margin-bottom: 20px; color: var(--up-green); }
    .filter-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .filter-item { display: flex; flex-direction: column; }
    .filter-item label { font-weight: 600; margin-bottom: 6px; color: var(--text-primary); font-size: 0.9em; }
    .filter-item select, .filter-item input { padding: 10px 14px; border: 2px solid var(--border); border-radius: var(--radius); font-size: 0.95em; }
    .filter-item select:focus, .filter-item input:focus { outline: none; border-color: var(--up-green); box-shadow: 0 0 0 3px var(--primary-light); }

    /* Stage Filter Buttons */
    .stage-filter { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .stage-btn { padding: 8px 16px; border: 2px solid var(--border); background: var(--bg-white); border-radius: var(--radius); cursor: pointer; font-weight: 600; min-width: 50px; text-align: center; transition: all 0.2s ease; }
    .stage-btn:hover { border-color: var(--up-green); color: var(--up-green); }
    .stage-btn.active { background: var(--up-green); color: white; border-color: var(--up-green); }

    /* Filter Actions */
    .filter-actions { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; }

    /* Table Section */
    .table-section { background: var(--bg-white); border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden; }
    .table-header { padding: 20px 24px; background: var(--bg-main); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
    .table-header h2 { font-size: 1.1em; color: var(--up-green); margin: 0; }

    /* Submissions Table */
    .submissions-table { width: 100%; border-collapse: collapse; }
    .submissions-table thead { background: var(--up-green); color: white; }
    .submissions-table th { padding: 14px 20px; text-align: left; font-weight: 600; font-size: 0.9em; }
    .submissions-table td { padding: 14px 20px; border-bottom: 1px solid var(--border-light); }
    .submissions-table tbody tr:hover { background: var(--primary-light); }

    /* Stage Badges */
    .stage-badge { display: inline-block; padding: 4px 12px; border-radius: var(--radius); font-weight: 600; font-size: 0.85em; text-align: center; }
    .stage-1 { background: #E3F2FD; color: #1565C0; }
    .stage-2 { background: #F3E5F5; color: #6A1B9A; }
    .stage-3 { background: #FCE4EC; color: #C2185B; }
    .stage-4 { background: #FFF3E0; color: #E65100; }
    .stage-5 { background: #E0F2F1; color: #00695C; }
    .stage-6 { background: #F1F8E9; color: #558B2F; }

    /* Table Actions */
    .table-actions-cell { display: flex; gap: 8px; flex-wrap: wrap; }

    /* Group Name Link */
    .group-name-link { color: var(--up-green); text-decoration: none; transition: all 0.2s ease; }
    .group-name-link:hover { color: #238A79; text-decoration: underline; }

    /* Sortable Columns */
    .submissions-table th.sortable { cursor: pointer; user-select: none; white-space: nowrap; }
    .submissions-table th.sortable:hover { background-color: #238A79; }
    .sort-icon { margin-left: 6px; opacity: 0.5; font-size: 0.9em; }
    .sort-icon.active { opacity: 1; color: var(--up-gold); }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .empty-state-icon { font-size: 3em; margin-bottom: 16px; opacity: 0.5; }

    /* Responsive */
    @media (max-width: 768px) {
        .filter-group { grid-template-columns: 1fr; }
        .table-actions-cell { flex-direction: column; }
        .submissions-table th, .submissions-table td { padding: 10px 12px; font-size: 0.85em; }
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<a href="/" class="breadcrumb-item">Home</a>
<span class="breadcrumb-separator">/</span>
<a href="/admin" class="breadcrumb-item">Admin</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-current">All Submissions</span>
{% endblock %}

{% block content %}
<h1 class="page-title">All Submissions</h1>
<p class="page-subtitle">View and manage all group submissions across all stages</p>

<!-- Alert Messages -->
<div id="messageContainer"></div>

<!-- Filter Panel -->
<div class="filter-panel">
    <h2>Filters</h2>
    <div class="filter-group">
        <div class="filter-item">
            <label for="groupFilter">Group</label>
            <select id="groupFilter" aria-label="Filter by group">
                <option value="">All Groups</option>
            </select>
        </div>
        <div class="filter-item">
            <label for="searchFilter">Search</label>
            <input type="text" id="searchFilter" placeholder="Search by project title, group name..." aria-label="Search submissions">
        </div>
    </div>

    <div class="filter-item">
        <label>Stage</label>
        <div class="stage-filter" role="group" aria-label="Filter by stage">
            <button type="button" class="stage-btn" data-stage="1">1</button>
            <button type="button" class="stage-btn" data-stage="2">2</button>
            <button type="button" class="stage-btn" data-stage="3">3</button>
            <button type="button" class="stage-btn" data-stage="4">4</button>
            <button type="button" class="stage-btn" data-stage="5">5</button>
            <button type="button" class="stage-btn" data-stage="6">6</button>
        </div>
    </div>

    <div class="filter-actions">
        <button class="btn btn-primary" id="applyFiltersBtn">Apply Filters</button>
        <button class="btn btn-secondary" id="clearFiltersBtn">Clear Filters</button>
        <button class="btn btn-primary" id="exportCsvBtn" style="background: var(--up-gold); color: var(--up-green-dark);">Export CSV</button>
    </div>
</div>

<!-- Table Section -->
<div class="table-section">
    <div class="table-header">
        <h2>Submissions <span id="submissionCount"></span></h2>
        <button class="btn btn-sm btn-primary" id="refreshBtn">Refresh</button>
    </div>

    <div id="tableContainer">
        <div class="empty-state">
            <div class="spinner"></div>
            <p>Loading submissions...</p>
        </div>
    </div>
</div>

<!-- Submission Details Modal -->
<div id="detailsModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="detailsModalTitle">
    <div class="modal" style="max-width: 700px;">
        <header class="modal-header">
            <h2 id="detailsModalTitle" class="modal-title">Submission Details</h2>
            <button type="button" class="modal-close" id="detailsCloseBtn" aria-label="Close modal">
                <span aria-hidden="true">&times;</span>
            </button>
        </header>
        <div class="modal-body" id="detailsContent">
            <!-- Details loaded dynamically -->
        </div>
    </div>
</div>

<!-- PDF Viewer Modal -->
<div id="pdfModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="pdfModalTitle">
    <div class="modal" style="max-width: 900px;">
        <header class="modal-header">
            <h2 id="pdfModalTitle" class="modal-title">PDF Viewer</h2>
            <button type="button" class="modal-close" id="pdfCloseBtn" aria-label="Close modal">
                <span aria-hidden="true">&times;</span>
            </button>
        </header>
        <div class="modal-body">
            <iframe id="pdfViewer" style="width: 100%; height: 500px; border: none;" aria-label="PDF content viewer"></iframe>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const CONFIG = { apiBaseUrl: '/api', adminEndpoint: '/api/admin', groupsEndpoint: '/api/groups', debounceDelay: 300 };

    const state = {
        allSubmissions: [],  // All submissions from API
        filteredSubmissions: [],  // After client-side filtering
        groups: [],
        filters: { groupId: '', stages: [], search: '' },
        sort: { column: 'submitted_at', direction: 'desc' },
        debounceTimer: null,
        isLoading: false
    };

    const elements = {};

    document.addEventListener('DOMContentLoaded', function() {
        initElements();
        setupEventListeners();
        fetchGroups();
        fetchSubmissions();
    });

    function initElements() {
        elements.messageContainer = document.getElementById('messageContainer');
        elements.groupFilter = document.getElementById('groupFilter');
        elements.searchFilter = document.getElementById('searchFilter');
        elements.stageButtons = document.querySelectorAll('.stage-btn');
        elements.applyFiltersBtn = document.getElementById('applyFiltersBtn');
        elements.clearFiltersBtn = document.getElementById('clearFiltersBtn');
        elements.exportCsvBtn = document.getElementById('exportCsvBtn');
        elements.refreshBtn = document.getElementById('refreshBtn');
        elements.tableContainer = document.getElementById('tableContainer');
        elements.submissionCount = document.getElementById('submissionCount');
        elements.detailsModal = document.getElementById('detailsModal');
        elements.detailsCloseBtn = document.getElementById('detailsCloseBtn');
        elements.detailsContent = document.getElementById('detailsContent');
        elements.pdfModal = document.getElementById('pdfModal');
        elements.pdfCloseBtn = document.getElementById('pdfCloseBtn');
        elements.pdfViewer = document.getElementById('pdfViewer');
    }

    function setupEventListeners() {
        elements.stageButtons.forEach(btn => btn.addEventListener('click', () => {
            btn.classList.toggle('active');
            applyFilters();
        }));
        elements.searchFilter.addEventListener('input', () => {
            clearTimeout(state.debounceTimer);
            state.debounceTimer = setTimeout(applyFilters, CONFIG.debounceDelay);
        });
        elements.groupFilter.addEventListener('change', applyFilters);
        elements.applyFiltersBtn.addEventListener('click', applyFilters);
        elements.clearFiltersBtn.addEventListener('click', clearFilters);
        elements.exportCsvBtn.addEventListener('click', exportToCsv);
        elements.refreshBtn.addEventListener('click', () => { fetchSubmissions(); showMessage('Submissions refreshed', 'success'); });

        elements.detailsCloseBtn.addEventListener('click', () => closeModal(elements.detailsModal));
        elements.pdfCloseBtn.addEventListener('click', () => closeModal(elements.pdfModal));
        elements.detailsModal.addEventListener('click', (e) => { if (e.target === elements.detailsModal) closeModal(elements.detailsModal); });
        elements.pdfModal.addEventListener('click', (e) => { if (e.target === elements.pdfModal) closeModal(elements.pdfModal); });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal(elements.detailsModal);
                closeModal(elements.pdfModal);
            }
        });
    }

    function openModal(modal) { modal.classList.add('active'); document.body.style.overflow = 'hidden'; }
    function closeModal(modal) { modal.classList.remove('active'); document.body.style.overflow = ''; }

    function showMessage(message, type = 'info') {
        const alertClass = type === 'error' ? 'alert-error' : 'alert-success';
        elements.messageContainer.innerHTML = `<div class="alert ${alertClass}" onclick="this.remove()">${message}</div>`;
        if (type !== 'error') setTimeout(() => elements.messageContainer.innerHTML = '', 4000);
    }

    function formatDate(dateString) {
        return dateString ? new Date(dateString).toLocaleString() : 'N/A';
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function fetchGroups() {
        try {
            const response = await fetch(CONFIG.groupsEndpoint);
            if (!response.ok) throw new Error('Failed to fetch groups');
            state.groups = await response.json();
            populateGroupFilter();
        } catch (error) {
            console.error('Error fetching groups:', error);
        }
    }

    function populateGroupFilter() {
        elements.groupFilter.innerHTML = '<option value="">All Groups</option>';
        state.groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = group.group_name || group.name;
            elements.groupFilter.appendChild(option);
        });
    }

    async function fetchSubmissions() {
        state.isLoading = true;
        try {
            // Only send group_id to API (server-side filter)
            const params = new URLSearchParams();
            if (state.filters.groupId) params.append('group_id', state.filters.groupId);

            const response = await fetch(`${CONFIG.adminEndpoint}/submissions?${params.toString()}`);
            if (!response.ok) throw new Error('Failed to fetch submissions');

            state.allSubmissions = await response.json();
            applyClientFilters();
        } catch (error) {
            console.error('Error fetching submissions:', error);
            showMessage('Failed to load submissions', 'error');
            elements.tableContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#9888;</div><p>Error loading submissions. Please try again.</p></div>';
        } finally {
            state.isLoading = false;
        }
    }

    function updateFilters() {
        state.filters.groupId = elements.groupFilter.value;
        state.filters.search = elements.searchFilter.value.toLowerCase().trim();
        state.filters.stages = Array.from(elements.stageButtons).filter(btn => btn.classList.contains('active')).map(btn => parseInt(btn.dataset.stage));
    }

    function applyClientFilters() {
        updateFilters();
        let filtered = [...state.allSubmissions];

        // Filter by stages (client-side)
        if (state.filters.stages.length > 0) {
            filtered = filtered.filter(s => state.filters.stages.includes(s.stage));
        }

        // Filter by search (client-side)
        if (state.filters.search) {
            filtered = filtered.filter(s =>
                (s.group_name && s.group_name.toLowerCase().includes(state.filters.search)) ||
                (s.project_title && s.project_title.toLowerCase().includes(state.filters.search))
            );
        }

        // Apply sorting
        filtered = sortSubmissions(filtered);

        state.filteredSubmissions = filtered;
        renderSubmissionsTable();
    }

    function applyFilters() {
        // If group filter changed, refetch from API; otherwise just filter client-side
        const currentGroupId = elements.groupFilter.value;
        if (currentGroupId !== state.filters.groupId) {
            state.filters.groupId = currentGroupId;
            fetchSubmissions();
        } else {
            applyClientFilters();
        }
    }

    function clearFilters() {
        elements.groupFilter.value = '';
        elements.searchFilter.value = '';
        elements.stageButtons.forEach(btn => btn.classList.remove('active'));
        state.filters = { groupId: '', stages: [], search: '' };
        state.sort = { column: 'submitted_at', direction: 'desc' };
        fetchSubmissions();
    }

    function sortSubmissions(submissions) {
        const { column, direction } = state.sort;
        const modifier = direction === 'asc' ? 1 : -1;

        return submissions.sort((a, b) => {
            let aVal = a[column];
            let bVal = b[column];

            // Handle dates
            if (column === 'submitted_at') {
                aVal = aVal ? new Date(aVal).getTime() : 0;
                bVal = bVal ? new Date(bVal).getTime() : 0;
                return (aVal - bVal) * modifier;
            }

            // Handle numbers (stage)
            if (column === 'stage') {
                return ((aVal || 0) - (bVal || 0)) * modifier;
            }

            // Handle strings
            aVal = (aVal || '').toString().toLowerCase();
            bVal = (bVal || '').toString().toLowerCase();
            return aVal.localeCompare(bVal) * modifier;
        });
    }

    function handleSort(column) {
        if (state.sort.column === column) {
            state.sort.direction = state.sort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            state.sort.column = column;
            state.sort.direction = 'asc';
        }
        applyClientFilters();
    }

    function getSortIcon(column) {
        if (state.sort.column !== column) return '<span class="sort-icon">&#8597;</span>';
        return state.sort.direction === 'asc'
            ? '<span class="sort-icon active">&#8593;</span>'
            : '<span class="sort-icon active">&#8595;</span>';
    }

    function renderSubmissionsTable() {
        const submissions = state.filteredSubmissions;

        if (submissions.length === 0) {
            elements.tableContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#128235;</div><p>No submissions found</p></div>';
            elements.submissionCount.textContent = '(0)';
            return;
        }

        let html = `
            <table class="submissions-table" id="submissionsTable">
                <thead>
                    <tr>
                        <th scope="col" class="sortable" onclick="handleSort('group_name')">Group Name ${getSortIcon('group_name')}</th>
                        <th scope="col" class="sortable" onclick="handleSort('project_title')">Project Title ${getSortIcon('project_title')}</th>
                        <th scope="col" class="sortable" onclick="handleSort('stage')">Stage ${getSortIcon('stage')}</th>
                        <th scope="col" class="sortable" onclick="handleSort('submitted_at')">Submitted At ${getSortIcon('submitted_at')}</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody>
        `;

        submissions.forEach(submission => {
            const stageBadge = `<span class="stage-badge stage-${submission.stage}">Stage ${submission.stage}</span>`;
            const fileName = submission.file_name || 'N/A';
            const isPdf = fileName.toLowerCase().endsWith('.pdf');

            html += `
                <tr>
                    <td><a href="/admin/group/${submission.group_id}" class="group-name-link"><strong>${escapeHtml(submission.group_name)}</strong></a></td>
                    <td>${escapeHtml(submission.project_title)}</td>
                    <td>${stageBadge}</td>
                    <td>${formatDate(submission.submitted_at)}</td>
                    <td>
                        <div class="table-actions-cell">
                            <button class="btn btn-sm btn-primary" onclick="viewDetails('${submission.id}')">Details</button>
                            <button class="btn btn-sm btn-secondary" onclick="downloadFile('${submission.id}')">Download</button>
                            ${isPdf ? `<button class="btn btn-sm btn-primary" style="background: var(--up-gold); color: var(--up-green-dark);" onclick="viewPdf('${submission.id}')">View PDF</button>` : ''}
                        </div>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        elements.tableContainer.innerHTML = html;
        elements.submissionCount.textContent = `(${submissions.length})`;
    }

    async function viewDetails(submissionId) {
        elements.detailsContent.innerHTML = '<div class="empty-state"><div class="spinner"></div><p>Loading details...</p></div>';
        openModal(elements.detailsModal);

        try {
            const response = await fetch(`${CONFIG.adminEndpoint}/submissions/${submissionId}`);
            if (!response.ok) throw new Error('Failed to fetch details');

            const details = await response.json();
            elements.detailsContent.innerHTML = `
                <div class="detail-row"><span class="detail-label">Group Name</span><span class="detail-value">${escapeHtml(details.group_name)}</span></div>
                <div class="detail-row"><span class="detail-label">Project Title</span><span class="detail-value">${escapeHtml(details.project_title)}</span></div>
                <div class="detail-row"><span class="detail-label">Stage</span><span class="detail-value"><span class="stage-badge stage-${details.stage}">Stage ${details.stage}</span></span></div>
                <div class="detail-row"><span class="detail-label">Members</span><span class="detail-value">${details.members ? escapeHtml(details.members.join(', ')) : 'N/A'}</span></div>
                <div class="detail-row"><span class="detail-label">Description</span><span class="detail-value">${escapeHtml(details.description || 'N/A')}</span></div>
                <div class="detail-row"><span class="detail-label">File Name</span><span class="detail-value">${escapeHtml(details.file_name || 'N/A')}</span></div>
                <div class="detail-row"><span class="detail-label">Submitted At</span><span class="detail-value">${formatDate(details.submitted_at)}</span></div>
            `;
        } catch (error) {
            elements.detailsContent.innerHTML = '<div class="alert alert-error">Failed to load submission details</div>';
        }
    }

    function viewPdf(submissionId) {
        elements.pdfViewer.src = `${CONFIG.adminEndpoint}/view/${submissionId}`;
        openModal(elements.pdfModal);
    }

    function downloadFile(submissionId) {
        const link = document.createElement('a');
        link.href = `${CONFIG.adminEndpoint}/download/${submissionId}`;
        link.download = '';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function exportToCsv() {
        if (state.filteredSubmissions.length === 0) {
            showMessage('No submissions to export', 'error');
            return;
        }

        const headers = ['Group Name', 'Project Title', 'Stage', 'Submitted At'];
        const rows = state.filteredSubmissions.map(s => [s.group_name, s.project_title, s.stage, formatDate(s.submitted_at)]);
        const csv = [headers, ...rows].map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `submissions-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showMessage('Submissions exported to CSV', 'success');
    }
</script>
{% endblock %}
