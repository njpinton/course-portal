{% extends "base_layout.html" %}

{% block title %}Admin Dashboard - CMSC 173{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin-dashboard.css') }}">
{% endblock %}

{% block breadcrumbs %}
<a href="/" class="breadcrumb-item">Home</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-current">Admin Dashboard</span>
{% endblock %}

{% block header_actions %}
<a href="/admin_logout" class="btn btn-secondary" style="background: var(--up-maroon); color: white; border: none;">Logout</a>
{% endblock %}

{% block content %}
<!-- DASHBOARD HEADER -->
<div class="dashboard-header">
    <div class="dashboard-title">
        <h1>Admin Dashboard</h1>
        <p>CMSC 173 Group Project Portal - System Overview</p>
    </div>
    <div class="dashboard-actions">
        <a href="/admin_roster" class="btn-action secondary">Student Roster</a>
        <a href="/admin_class_records" class="btn-action secondary">Class Records</a>
        <a href="/admin_submissions" class="btn-action secondary">All Submissions</a>
        <a href="/group_portal" class="btn-action secondary">View Groups</a>
    </div>
</div>

<!-- ALERTS CONTAINER -->
<div id="alertsContainer"></div>

<!-- STATISTICS CARDS -->
<div class="statistics-grid">
    <div class="stat-card loading" id="totalGroupsCard">
        <div class="stat-icon">üìä</div>
        <div class="stat-label">Total Groups</div>
        <div class="stat-value"><span class="loading-spinner"></span></div>
        <div class="stat-subtext">Active groups</div>
    </div>

    <div class="stat-card loading" id="totalSubmissionsCard">
        <div class="stat-icon">üìù</div>
        <div class="stat-label">Total Submissions</div>
        <div class="stat-value"><span class="loading-spinner"></span></div>
        <div class="stat-subtext">All stages combined</div>
    </div>

    <div class="stat-card loading" id="avgSubmissionsCard">
        <div class="stat-icon">üìà</div>
        <div class="stat-label">Avg Submissions per Group</div>
        <div class="stat-value"><span class="loading-spinner"></span></div>
        <div class="stat-subtext">Average across all groups</div>
    </div>
</div>

<!-- STAGE COMPLETION SECTION -->
<div class="stages-section">
    <h2>Stage Completion Overview</h2>
    <div id="stagesContainer">
        <div class="empty-state">
            <div class="empty-state-icon">‚è≥</div>
            <div class="empty-state-text">Loading stage data...</div>
        </div>
    </div>
</div>

<!-- GROUPS SUBMISSION STATUS SECTION -->
<div class="submissions-section">
    <h2>Groups Submission Status by Stage</h2>
    <div class="table-wrapper" style="overflow-x: auto;">
        <table class="submissions-table" id="groupsStatusTable">
            <thead>
                <tr>
                    <th>Group Name</th>
                    <th>Project Title</th>
                    <th>Stage 1<br><small>Proposal</small></th>
                    <th>Stage 2<br><small>Data & Prep</small></th>
                    <th>Stage 3<br><small>Training</small></th>
                    <th>Stage 4<br><small>Evaluation</small></th>
                    <th>Stage 5<br><small>Final Report</small></th>
                    <th>Stage 6<br><small>Presentation</small></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="groupsStatusTableBody">
                <tr>
                    <td colspan="9" style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <span class="loading-spinner"></span> Loading groups...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- RECENT SUBMISSIONS SECTION -->
<div class="submissions-section">
    <h2>Stage 1 Submissions</h2>

    <!-- FILTER CONTROLS -->
    <div class="submissions-filter">
        <div class="filter-group">
            <label class="filter-label">Filter by Stage:</label>
            <select id="stageFilter" class="filter-select">
                <option value="">All Stages</option>
                <option value="1">Stage 1 - Proposal</option>
                <option value="2">Stage 2 - Data & Prep</option>
                <option value="3">Stage 3 - Training</option>
                <option value="4">Stage 4 - Evaluation</option>
                <option value="5">Stage 5 - Final Report</option>
                <option value="6">Stage 6 - Presentation</option>
            </select>
        </div>
        <button class="filter-btn" id="applyFilterBtn">Apply Filter</button>
        <button class="filter-btn reset" id="resetFilterBtn">Reset</button>
        <span class="submissions-count" id="submissionsCount"></span>
    </div>

    <!-- SCROLLABLE TABLE -->
    <div class="scrollable-table-wrapper">
        <table class="submissions-table" id="submissionsTable">
            <thead>
                <tr>
                    <th>Group Name</th>
                    <th>Project Title</th>
                    <th>Stage</th>
                    <th>Submitted Date</th>
                </tr>
            </thead>
            <tbody id="submissionsTableBody">
                <tr>
                    <td colspan="4" style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                        <span class="loading-spinner"></span> Loading submissions...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Feedback Button -->
<button class="feedback-btn" id="feedbackBtn" title="Report issue or feedback">üí¨</button>

<!-- Feedback Modal -->
<div id="feedbackModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="feedbackTitle">
    <div class="modal" style="max-width: 500px;">
        <header class="modal-header">
            <h2 id="feedbackTitle" class="modal-title">Share Feedback</h2>
            <button type="button" class="modal-close" id="closeFeedbackModal" aria-label="Close modal">
                <span aria-hidden="true">&times;</span>
            </button>
        </header>
        <div class="modal-body">
            <form id="feedbackForm">
                <div class="form-group">
                    <label for="feedbackType" class="form-label">Feedback Type</label>
                    <select id="feedbackType" class="form-select" required>
                        <option value="">Select type...</option>
                        <option value="bug">Bug Report</option>
                        <option value="feature">Feature Request</option>
                        <option value="improvement">Improvement</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="feedbackMessage" class="form-label required">Your Feedback</label>
                    <textarea id="feedbackMessage" class="form-textarea" rows="4" placeholder="Please describe your feedback in detail..." required></textarea>
                </div>
                <div class="modal-footer" style="border: none; padding: 0;">
                    <button type="button" class="btn btn-ghost" id="cancelFeedback">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Feedback</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/admin-dashboard.js') }}"></script>
<script>
// Feedback Modal Handler
(function() {
    const feedbackBtn = document.getElementById('feedbackBtn');
    const feedbackModal = document.getElementById('feedbackModal');
    const closeFeedbackModal = document.getElementById('closeFeedbackModal');
    const cancelFeedback = document.getElementById('cancelFeedback');
    const feedbackForm = document.getElementById('feedbackForm');

    function openModal() {
        feedbackModal.classList.add('active');
        document.body.style.overflow = 'hidden';
        document.getElementById('feedbackType').focus();
    }

    function closeModal() {
        feedbackModal.classList.remove('active');
        document.body.style.overflow = '';
        feedbackForm.reset();
    }

    feedbackBtn.addEventListener('click', openModal);
    closeFeedbackModal.addEventListener('click', closeModal);
    cancelFeedback.addEventListener('click', closeModal);
    feedbackModal.addEventListener('click', (e) => { if (e.target === feedbackModal) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && feedbackModal.classList.contains('active')) closeModal(); });

    feedbackForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const type = document.getElementById('feedbackType').value;
        const message = document.getElementById('feedbackMessage').value;
        console.log('Feedback submitted:', { type, message });
        closeModal();
        // Show success toast if available
        if (typeof showToast === 'function') {
            showToast('Thank you for your feedback!', 'success');
        } else {
            alert('Thank you for your feedback!');
        }
    });
})();
</script>
{% endblock %}
