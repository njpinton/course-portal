{% extends "base_layout.html" %}

{% block title %}Student Roster - CMSC 173{% endblock %}

{% block extra_css %}
<style>
    /* Student Roster Page-Specific Styles */

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: linear-gradient(135deg, var(--up-green) 0%, var(--up-green-dark) 100%); color: white; padding: 20px; border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow); }
    .stat-card h3 { font-size: 0.9em; margin-bottom: 10px; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card .value { font-size: 2em; font-weight: bold; }

    /* Controls */
    .controls { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
    .controls input, .controls select { padding: 10px 14px; border: 2px solid var(--border); border-radius: var(--radius); font-size: 0.95em; background: var(--bg-white); }
    .controls input { flex: 1; min-width: 250px; }
    .controls input:focus, .controls select:focus { outline: none; border-color: var(--up-green); box-shadow: 0 0 0 3px var(--primary-light); }

    /* Table */
    .table-wrapper { overflow-x: auto; margin-bottom: 20px; background: var(--bg-white); border-radius: var(--radius-lg); border: 1px solid var(--border); }
    .roster-table { width: 100%; border-collapse: collapse; }
    .roster-table th { background: var(--up-green); color: white; padding: 14px 16px; text-align: left; font-weight: 600; font-size: 0.9em; }
    .roster-table td { padding: 12px 16px; border-bottom: 1px solid var(--border-light); }
    .roster-table tbody tr:hover { background: var(--primary-light); }
    .roster-table a { color: var(--up-green); }

    /* Status Badges */
    .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
    .status-ungrouped { background: var(--up-gold-light); color: #92400E; }
    .status-grouped { background: #D1FAE5; color: #065F46; }

    /* Section Headers */
    .section-header { background: var(--up-green); color: white; padding: 12px 16px; border-radius: var(--radius); margin-bottom: 16px; font-size: 1em; font-weight: 600; }

    /* Actions */
    .action-view { padding: 6px 14px; background: var(--up-green); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-size: 0.85em; font-weight: 500; }
    .action-view:hover { background: var(--up-green-dark); }

    /* Empty State */
    .empty-state { text-align: center; padding: 40px; color: var(--text-muted); }
    .empty-state-icon { font-size: 3em; margin-bottom: 16px; opacity: 0.5; }

    /* Page Header */
    .page-title { color: var(--up-green); font-size: 1.6em; margin-bottom: 8px; }
    .page-subtitle { color: var(--text-secondary); font-size: 0.95em; margin-bottom: 24px; }

    /* Responsive */
    @media (max-width: 768px) {
        .controls { flex-direction: column; }
        .controls input, .controls select { width: 100%; min-width: auto; }
        .stat-card .value { font-size: 1.6em; }
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<a href="/" class="breadcrumb-item">Home</a>
<span class="breadcrumb-separator">/</span>
<a href="/admin" class="breadcrumb-item">Admin</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-current">Student Roster</span>
{% endblock %}

{% block content %}
<h1 class="page-title">Student Roster</h1>
<p class="page-subtitle">CMSC 173 - Machine Learning - All Sections</p>

<!-- Alert Messages -->
<div id="alertContainer"></div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <h3>Total Students</h3>
        <div class="value" id="totalStudents">-</div>
    </div>
    <div class="stat-card">
        <h3>Grouped</h3>
        <div class="value" id="groupedCount">-</div>
    </div>
    <div class="stat-card">
        <h3>Ungrouped</h3>
        <div class="value" id="ungroupedCount">-</div>
    </div>
    <div class="stat-card">
        <h3>Grouping %</h3>
        <div class="value" id="groupingPercent">-%</div>
    </div>
</div>

<!-- Controls -->
<div class="controls">
    <input type="text" id="searchInput" placeholder="Search by name, email, or campus ID..." aria-label="Search students">
    <select id="filterSection" aria-label="Filter by section">
        <option value="">All Sections</option>
        <option value="cmsc173a">Section A (Tue-Fri 3:00-4:30 PM)</option>
        <option value="cmsc173d">Section D (Tue-Fri 4:30-6:00 PM)</option>
        <option value="cmsc173e">Section E (Mon-Thu 3:00-4:30 PM)</option>
    </select>
    <select id="filterStatus" aria-label="Filter by status">
        <option value="">All Students</option>
        <option value="grouped">Grouped Only</option>
        <option value="ungrouped">Ungrouped Only</option>
    </select>
    <select id="filterProgram" aria-label="Filter by program">
        <option value="">All Programs</option>
        <option value="BSCS">BSCS</option>
        <option value="BSMAT">BSMAT</option>
    </select>
    <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
    <button class="btn btn-primary" onclick="exportCSV()">Export CSV</button>
</div>

<!-- Students Table -->
<div id="tableContainer">
    <div class="empty-state">
        <div class="spinner"></div>
        <p>Loading student roster...</p>
    </div>
</div>

<!-- Student Details Modal -->
<div id="studentModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="studentModalTitle">
    <div class="modal" style="max-width: 500px;">
        <header class="modal-header">
            <h2 id="studentModalTitle" class="modal-title">Student Details</h2>
            <button type="button" class="modal-close" id="closeStudentModal" aria-label="Close modal">
                <span aria-hidden="true">&times;</span>
            </button>
        </header>
        <div class="modal-body" id="studentModalContent">
            <!-- Content loaded dynamically -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allStudents = { ungrouped: [], grouped: [] };
    let filteredStudents = {};
    let sectionStudents = {};

    document.addEventListener('DOMContentLoaded', function() {
        loadAllSections();
        setupEventListeners();
        setupModal();
    });

    function setupEventListeners() {
        document.getElementById('searchInput').addEventListener('input', filterStudents);
        document.getElementById('filterSection').addEventListener('change', filterStudents);
        document.getElementById('filterStatus').addEventListener('change', filterStudents);
        document.getElementById('filterProgram').addEventListener('change', filterStudents);
    }

    function setupModal() {
        const modal = document.getElementById('studentModal');
        const closeBtn = document.getElementById('closeStudentModal');
        closeBtn.addEventListener('click', () => closeModal(modal));
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.classList.contains('active')) closeModal(modal); });
    }

    function openModal(modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal(modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }

    async function loadAllSections() {
        try {
            const sections = ['cmsc173a', 'cmsc173d', 'cmsc173e'];
            let totalStats = { total_students: 0, grouped_count: 0, ungrouped_count: 0 };

            for (const section of sections) {
                const response = await fetch(`/api/classes/${section}`);
                const data = await response.json();

                if (!response.ok) {
                    console.error(`Error loading ${section}:`, data.error);
                    continue;
                }

                sectionStudents[section] = {
                    ungrouped: data.ungrouped_students || [],
                    grouped: data.grouped_students || [],
                    schedule: data.class?.schedule || 'N/A'
                };

                totalStats.total_students += data.total_students || 0;
                totalStats.grouped_count += data.grouped_count || 0;
                totalStats.ungrouped_count += data.ungrouped_count || 0;
            }

            updateStats(totalStats);
            filterStudents();
        } catch (error) {
            console.error('Error:', error);
            showAlert('Failed to load student roster: ' + error.message, 'error');
        }
    }

    function updateStats(data) {
        document.getElementById('totalStudents').textContent = data.total_students;
        document.getElementById('groupedCount').textContent = data.grouped_count;
        document.getElementById('ungroupedCount').textContent = data.ungrouped_count;
        const percent = data.total_students > 0 ? Math.round((data.grouped_count / data.total_students) * 100) : 0;
        document.getElementById('groupingPercent').textContent = percent + '%';
    }

    function filterStudents() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const sectionFilter = document.getElementById('filterSection').value;
        const statusFilter = document.getElementById('filterStatus').value;
        const programFilter = document.getElementById('filterProgram').value;

        filteredStudents = { cmsc173a: [], cmsc173d: [], cmsc173e: [] };

        for (const section in sectionStudents) {
            if (sectionFilter && sectionFilter !== section) continue;

            let students = [];
            if (statusFilter === 'grouped' || statusFilter === '') students = students.concat(sectionStudents[section].grouped);
            if (statusFilter === 'ungrouped' || statusFilter === '') students = students.concat(sectionStudents[section].ungrouped);

            filteredStudents[section] = students.filter(student => {
                const matchesSearch = !searchTerm ||
                    student.first_name.toLowerCase().includes(searchTerm) ||
                    student.last_name.toLowerCase().includes(searchTerm) ||
                    student.email.toLowerCase().includes(searchTerm) ||
                    student.campus_id.includes(searchTerm);
                const matchesProgram = !programFilter || student.program === programFilter;
                return matchesSearch && matchesProgram;
            });
        }

        displayStudents();
    }

    function displayStudents() {
        const container = document.getElementById('tableContainer');
        const sections = ['cmsc173a', 'cmsc173d', 'cmsc173e'];
        const sectionNames = {
            cmsc173a: 'Section A (Tue-Fri 3:00-4:30 PM)',
            cmsc173d: 'Section D (Tue-Fri 4:30-6:00 PM)',
            cmsc173e: 'Section E (Mon-Thu 3:00-4:30 PM)'
        };

        const totalStudents = sections.reduce((sum, sec) => sum + filteredStudents[sec].length, 0);

        if (totalStudents === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#128269;</div><p>No students found matching your criteria.</p></div>';
            return;
        }

        let html = '';

        sections.forEach(section => {
            const students = filteredStudents[section];
            if (students.length === 0) return;

            html += `
                <div style="margin-bottom: 30px;">
                    <div class="section-header">${sectionNames[section]} (${students.length} student${students.length !== 1 ? 's' : ''})</div>
                    <div class="table-wrapper">
                        <table class="roster-table">
                            <thead>
                                <tr>
                                    <th scope="col">Campus ID</th>
                                    <th scope="col">Name</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Program</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">Group</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            students.forEach(student => {
                const status = student.group_id ? 'grouped' : 'ungrouped';
                const statusText = student.group_id ? 'Grouped' : 'Ungrouped';
                const fullName = `${student.first_name} ${student.last_name}`;
                const groupInfo = student.group_name || '-';

                html += `
                    <tr>
                        <td><strong>${escapeHtml(student.campus_id)}</strong></td>
                        <td>${escapeHtml(fullName)}</td>
                        <td><a href="mailto:${escapeHtml(student.email)}">${escapeHtml(student.email)}</a></td>
                        <td>${escapeHtml(student.program)}</td>
                        <td><span class="status-badge status-${status}">${statusText}</span></td>
                        <td>${escapeHtml(groupInfo)}</td>
                        <td><button class="action-view" onclick="viewStudentDetails('${student.id}')">View</button></td>
                    </tr>
                `;
            });

            html += '</tbody></table></div></div>';
        });

        container.innerHTML = html;
    }

    function viewStudentDetails(studentId) {
        let student = null;
        for (const section in filteredStudents) {
            student = filteredStudents[section].find(s => s.id === studentId);
            if (student) break;
        }
        if (!student) return;

        const fullName = `${student.first_name} ${student.last_name}`;
        const content = `
            <div class="detail-row"><span class="detail-label">Name</span><span class="detail-value">${escapeHtml(fullName)}</span></div>
            <div class="detail-row"><span class="detail-label">Campus ID</span><span class="detail-value">${escapeHtml(student.campus_id)}</span></div>
            <div class="detail-row"><span class="detail-label">Email</span><span class="detail-value"><a href="mailto:${escapeHtml(student.email)}">${escapeHtml(student.email)}</a></span></div>
            <div class="detail-row"><span class="detail-label">Program</span><span class="detail-value">${escapeHtml(student.program)}</span></div>
            <div class="detail-row"><span class="detail-label">Status</span><span class="detail-value"><span class="status-badge status-${student.group_id ? 'grouped' : 'ungrouped'}">${student.group_id ? 'Grouped' : 'Ungrouped'}</span></span></div>
            <div class="detail-row"><span class="detail-label">Group</span><span class="detail-value">${escapeHtml(student.group_name || 'Not assigned')}</span></div>
        `;
        document.getElementById('studentModalContent').innerHTML = content;
        document.getElementById('studentModalTitle').textContent = fullName;
        openModal(document.getElementById('studentModal'));
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('filterSection').value = '';
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterProgram').value = '';
        filterStudents();
    }

    function exportCSV() {
        const sections = ['cmsc173a', 'cmsc173d', 'cmsc173e'];
        const totalStudents = sections.reduce((sum, sec) => sum + filteredStudents[sec].length, 0);

        if (totalStudents === 0) {
            showAlert('No students to export', 'error');
            return;
        }

        let csv = 'Section,Campus ID,First Name,Last Name,Email,Program,Status,Group Name\n';
        const sectionNames = { cmsc173a: 'Section A', cmsc173d: 'Section D', cmsc173e: 'Section E' };

        sections.forEach(section => {
            filteredStudents[section].forEach(student => {
                const status = student.group_id ? 'Grouped' : 'Ungrouped';
                const groupName = student.group_name || 'Ungrouped';
                csv += `${sectionNames[section]},${student.campus_id},"${student.first_name}","${student.last_name}",${student.email},${student.program},${status},"${groupName}"\n`;
            });
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'cmsc173_roster.csv';
        a.click();
        showAlert('Roster exported successfully!', 'success');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showAlert(message, type = 'success') {
        const container = document.getElementById('alertContainer');
        const alertClass = type === 'error' ? 'alert-error' : 'alert-success';
        container.innerHTML = `<div class="alert ${alertClass}" onclick="this.remove()">${message}</div>`;
        setTimeout(() => container.innerHTML = '', 5000);
    }
</script>
{% endblock %}
