{% extends "base_layout.html" %}

{% block title %}Class Records - Admin{% endblock %}

{% block extra_css %}
<style>
    /* Class Records Page Styles */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: linear-gradient(135deg, var(--up-green) 0%, var(--up-green-dark) 100%); color: white; padding: 16px; border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow); }
    .stat-card h3 { font-size: 0.8em; margin-bottom: 8px; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card .value { font-size: 1.8em; font-weight: bold; }

    /* Selector Row */
    .selector-row { display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
    .selector-group { flex: 1; min-width: 200px; }
    .selector-group label { display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px; }
    .selector-group select { width: 100%; padding: 10px 14px; border: 2px solid var(--border); border-radius: var(--radius); font-size: 0.95em; background: var(--bg-white); }
    .selector-group select:focus { outline: none; border-color: var(--up-green); box-shadow: 0 0 0 3px var(--primary-light); }

    /* Assessment Header */
    .assessment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
    .assessment-info { flex: 1; }
    .assessment-info h3 { margin: 0 0 4px 0; color: var(--up-green); font-size: 1.1em; }
    .assessment-info p { margin: 0; color: var(--text-secondary); font-size: 0.9em; }
    .assessment-actions { display: flex; gap: 8px; }

    /* Controls */
    .controls { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .controls input { flex: 1; min-width: 250px; padding: 10px 14px; border: 2px solid var(--border); border-radius: var(--radius); font-size: 0.95em; background: var(--bg-white); }
    .controls input:focus { outline: none; border-color: var(--up-green); box-shadow: 0 0 0 3px var(--primary-light); }

    /* Table */
    .table-wrapper { overflow-x: auto; margin-bottom: 20px; background: var(--bg-white); border-radius: var(--radius-lg); border: 1px solid var(--border); }
    .records-table { width: 100%; border-collapse: collapse; }
    .records-table th { background: var(--up-green); color: white; padding: 12px 14px; text-align: left; font-weight: 600; font-size: 0.9em; position: sticky; top: 0; }
    .records-table td { padding: 10px 14px; border-bottom: 1px solid var(--border-light); vertical-align: middle; }
    .records-table tbody tr:hover { background: var(--primary-light); }

    /* Score input */
    .score-input { width: 80px; padding: 6px 10px; border: 1px solid var(--border); border-radius: var(--radius); text-align: center; font-size: 0.95em; }
    .score-input:focus { outline: none; border-color: var(--up-green); box-shadow: 0 0 0 2px var(--primary-light); }
    .score-input.invalid { border-color: #dc2626; }

    /* Save indicator */
    .save-status { font-size: 0.8em; margin-left: 6px; }
    .save-status.saving { color: var(--up-gold); }
    .save-status.saved { color: var(--up-green); }
    .save-status.error { color: #dc2626; }

    /* Empty State */
    .empty-state { text-align: center; padding: 50px 40px; color: var(--text-muted); }
    .empty-state-icon { font-size: 3em; margin-bottom: 16px; opacity: 0.5; }

    /* Page Header */
    .page-title { color: var(--up-green); font-size: 1.6em; margin-bottom: 8px; }
    .page-subtitle { color: var(--text-secondary); font-size: 0.95em; margin-bottom: 20px; }

    /* Group/Program badge */
    .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }
    .badge-group { background: var(--primary-light); color: var(--up-green); }
    .badge-program { background: #f3f4f6; color: #4b5563; }
    .no-group { color: var(--text-muted); font-style: italic; font-size: 0.85em; }

    /* Modal additions */
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary); }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 2px solid var(--border); border-radius: var(--radius); font-size: 0.95em; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--up-green); }
    .form-row { display: flex; gap: 16px; }
    .form-row .form-group { flex: 1; }

    /* Assessment type badge */
    .type-badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 600; text-transform: uppercase; }
    .type-exam { background: #dbeafe; color: #1d4ed8; }
    .type-quiz { background: #fef3c7; color: #92400e; }
    .type-project { background: #d1fae5; color: #065f46; }
    .type-assignment { background: #f3e8ff; color: #7c3aed; }

    /* Responsive */
    @media (max-width: 768px) {
        .selector-row { flex-direction: column; }
        .controls { flex-direction: column; }
        .controls input { width: 100%; min-width: auto; }
        .stat-card .value { font-size: 1.5em; }
        .form-row { flex-direction: column; }
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<a href="/" class="breadcrumb-item">Home</a>
<span class="breadcrumb-separator">/</span>
<a href="/admin" class="breadcrumb-item">Admin</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-current">Class Records</span>
{% endblock %}

{% block content %}
<h1 class="page-title">Class Records</h1>
<p class="page-subtitle">Track assessments and grades per class</p>

<!-- Alert Messages -->
<div id="alertContainer"></div>

<!-- Class and Assessment Selectors -->
<div class="selector-row">
    <div class="selector-group">
        <label for="classFilter">Class</label>
        <select id="classFilter" aria-label="Select class">
            <option value="">Select a class...</option>
        </select>
    </div>
    <div class="selector-group">
        <label for="assessmentFilter">Assessment</label>
        <select id="assessmentFilter" aria-label="Select assessment" disabled>
            <option value="">Select an assessment...</option>
        </select>
    </div>
</div>

<!-- Stats Grid (hidden until assessment selected) -->
<div class="stats-grid" id="statsGrid" style="display: none;">
    <div class="stat-card">
        <h3>Total Students</h3>
        <div class="value" id="totalStudents">-</div>
    </div>
    <div class="stat-card">
        <h3>Graded</h3>
        <div class="value" id="gradedCount">-</div>
    </div>
    <div class="stat-card">
        <h3>Average</h3>
        <div class="value" id="avgScore">-</div>
    </div>
    <div class="stat-card">
        <h3>Highest</h3>
        <div class="value" id="highScore">-</div>
    </div>
    <div class="stat-card">
        <h3>Lowest</h3>
        <div class="value" id="lowScore">-</div>
    </div>
</div>

<!-- Assessment Header (shown when assessment selected) -->
<div class="assessment-header" id="assessmentHeader" style="display: none;">
    <div class="assessment-info">
        <h3 id="assessmentName">-</h3>
        <p id="assessmentDetails">-</p>
    </div>
    <div class="assessment-actions">
        <button class="btn btn-secondary" onclick="openEditAssessmentModal()">Edit</button>
        <button class="btn btn-primary" onclick="openNewAssessmentModal()">+ New Assessment</button>
    </div>
</div>

<!-- Controls (shown when assessment selected) -->
<div class="controls" id="gradeControls" style="display: none;">
    <input type="text" id="searchInput" placeholder="Search by name or campus ID..." aria-label="Search students">
    <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
    <button class="btn btn-primary" onclick="exportCSV()">Export CSV</button>
</div>

<!-- Records Table -->
<div id="tableContainer">
    <div class="empty-state">
        <div class="empty-state-icon">&#128203;</div>
        <p>Select a class and assessment to view grades</p>
    </div>
</div>

<!-- New Assessment Modal -->
<div id="assessmentModal" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal" style="max-width: 500px;">
        <header class="modal-header">
            <h2 class="modal-title" id="assessmentModalTitle">New Assessment</h2>
            <button type="button" class="modal-close" onclick="closeAssessmentModal()" aria-label="Close modal">
                <span aria-hidden="true">&times;</span>
            </button>
        </header>
        <div class="modal-body">
            <form id="assessmentForm" onsubmit="saveAssessment(event)">
                <input type="hidden" id="editAssessmentId" value="">

                <div class="form-group">
                    <label for="assessmentNameInput">Name *</label>
                    <input type="text" id="assessmentNameInput" placeholder="e.g., Midterm Exam" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="assessmentType">Type</label>
                        <select id="assessmentType">
                            <option value="exam">Exam</option>
                            <option value="quiz">Quiz</option>
                            <option value="project">Project</option>
                            <option value="assignment">Assignment</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="maxScore">Max Score</label>
                        <input type="number" id="maxScore" value="100" min="1" step="0.01">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="weight">Weight (%)</label>
                        <input type="number" id="weight" placeholder="Optional" min="0" max="100" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="dueDate">Due Date</label>
                        <input type="datetime-local" id="dueDate">
                    </div>
                </div>

                <div class="form-group">
                    <label for="assessmentDescription">Description</label>
                    <textarea id="assessmentDescription" rows="2" placeholder="Optional notes about this assessment"></textarea>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAssessmentModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Assessment</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // State
    let allClasses = [];
    let assessments = [];
    let currentRecords = [];
    let filteredRecords = [];
    let currentClassId = null;
    let currentAssessmentId = null;
    let currentAssessment = null;
    let saveTimeout = {};

    document.addEventListener('DOMContentLoaded', function() {
        loadClasses();
        setupEventListeners();
    });

    function setupEventListeners() {
        document.getElementById('classFilter').addEventListener('change', onClassChange);
        document.getElementById('assessmentFilter').addEventListener('change', onAssessmentChange);
        document.getElementById('searchInput').addEventListener('input', filterRecords);
    }

    // --- Data Loading ---

    async function loadClasses() {
        try {
            const response = await fetch('/api/admin/classes');
            if (!response.ok) throw new Error('Failed to load classes');
            allClasses = await response.json();

            const select = document.getElementById('classFilter');
            allClasses.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = `${cls.course_code} ${cls.section} - ${cls.semester || 'No Semester'}`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading classes:', error);
            showAlert('Failed to load classes: ' + error.message, 'error');
        }
    }

    async function onClassChange() {
        currentClassId = document.getElementById('classFilter').value;
        const assessmentSelect = document.getElementById('assessmentFilter');

        if (!currentClassId) {
            assessmentSelect.disabled = true;
            assessmentSelect.innerHTML = '<option value="">Select an assessment...</option>';
            hideGradeUI();
            return;
        }

        // Load assessments for this class
        try {
            const response = await fetch(`/api/admin/assessments/${currentClassId}`);
            if (!response.ok) throw new Error('Failed to load assessments');
            assessments = await response.json();

            assessmentSelect.disabled = false;
            assessmentSelect.innerHTML = '<option value="">Select an assessment...</option>';

            if (assessments.length === 0) {
                assessmentSelect.innerHTML += '<option value="__new__">+ Create first assessment...</option>';
            } else {
                assessments.forEach(a => {
                    const option = document.createElement('option');
                    option.value = a.id;
                    option.textContent = `${a.name} (${a.type})`;
                    assessmentSelect.appendChild(option);
                });
                assessmentSelect.innerHTML += '<option value="__new__">+ Create new assessment...</option>';
            }

            hideGradeUI();

        } catch (error) {
            console.error('Error loading assessments:', error);
            showAlert('Failed to load assessments: ' + error.message, 'error');
        }
    }

    async function onAssessmentChange() {
        currentAssessmentId = document.getElementById('assessmentFilter').value;

        if (currentAssessmentId === '__new__') {
            openNewAssessmentModal();
            document.getElementById('assessmentFilter').value = '';
            return;
        }

        if (!currentAssessmentId) {
            hideGradeUI();
            return;
        }

        currentAssessment = assessments.find(a => a.id === currentAssessmentId);
        showGradeUI();
        await loadGrades();
    }

    async function loadGrades() {
        document.getElementById('tableContainer').innerHTML = `
            <div class="empty-state">
                <div class="spinner"></div>
                <p>Loading grades...</p>
            </div>
        `;

        try {
            // Load students with grades for this class/assessment
            const response = await fetch(`/api/admin/grades/class/${currentClassId}?assessment_id=${currentAssessmentId}`);
            if (!response.ok) throw new Error('Failed to load grades');
            currentRecords = await response.json();

            // Also load stats
            const statsResponse = await fetch(`/api/admin/assessments/${currentAssessmentId}/stats`);
            if (statsResponse.ok) {
                const stats = await statsResponse.json();
                updateStats(stats);
            }

            filterRecords();
        } catch (error) {
            console.error('Error loading grades:', error);
            showAlert('Failed to load grades: ' + error.message, 'error');
            document.getElementById('tableContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">&#9888;</div>
                    <p>Failed to load grades. Please try again.</p>
                </div>
            `;
        }
    }

    // --- UI State ---

    function hideGradeUI() {
        document.getElementById('statsGrid').style.display = 'none';
        document.getElementById('assessmentHeader').style.display = 'none';
        document.getElementById('gradeControls').style.display = 'none';
        document.getElementById('tableContainer').innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">&#128203;</div>
                <p>Select a class and assessment to view grades</p>
            </div>
        `;
    }

    function showGradeUI() {
        document.getElementById('statsGrid').style.display = 'grid';
        document.getElementById('assessmentHeader').style.display = 'flex';
        document.getElementById('gradeControls').style.display = 'flex';

        // Update assessment info
        if (currentAssessment) {
            document.getElementById('assessmentName').textContent = currentAssessment.name;
            const typeClass = `type-${currentAssessment.type}`;
            const details = [];
            details.push(`<span class="type-badge ${typeClass}">${currentAssessment.type}</span>`);
            details.push(`Max: ${currentAssessment.max_score}`);
            if (currentAssessment.weight) details.push(`Weight: ${currentAssessment.weight}%`);
            document.getElementById('assessmentDetails').innerHTML = details.join(' &bull; ');
        }
    }

    function updateStats(stats) {
        document.getElementById('totalStudents').textContent = stats.total_students || '-';
        document.getElementById('gradedCount').textContent = stats.graded_count || '0';
        document.getElementById('avgScore').textContent = stats.average_score !== null ? stats.average_score : '-';
        document.getElementById('highScore').textContent = stats.highest_score !== null ? stats.highest_score : '-';
        document.getElementById('lowScore').textContent = stats.lowest_score !== null ? stats.lowest_score : '-';
    }

    // --- Filtering & Display ---

    function filterRecords() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        filteredRecords = currentRecords.filter(student => {
            const fullName = `${student.first_name} ${student.last_name}`.toLowerCase();
            return !searchTerm ||
                fullName.includes(searchTerm) ||
                student.campus_id.toLowerCase().includes(searchTerm);
        });

        displayRecords();
    }

    function displayRecords() {
        const container = document.getElementById('tableContainer');

        if (filteredRecords.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">&#128269;</div>
                    <p>No students found matching your criteria.</p>
                </div>
            `;
            return;
        }

        const maxScore = currentAssessment ? currentAssessment.max_score : 100;

        let html = `
            <div class="table-wrapper">
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>Campus ID</th>
                            <th>Name</th>
                            <th>Program</th>
                            <th style="text-align: center;">Score (/${maxScore})</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        filteredRecords.forEach(student => {
            const fullName = `${student.first_name} ${student.last_name}`;
            const grade = student.grades[currentAssessmentId] || {};
            const scoreValue = grade.score !== null && grade.score !== undefined ? grade.score : '';
            const notesValue = grade.notes || '';

            html += `
                <tr data-student-id="${student.id}">
                    <td><strong>${escapeHtml(student.campus_id)}</strong></td>
                    <td>${escapeHtml(fullName)}</td>
                    <td><span class="badge badge-program">${escapeHtml(student.program || '-')}</span></td>
                    <td style="text-align: center;">
                        <input type="number" class="score-input" value="${scoreValue}"
                            min="0" max="${maxScore}" step="0.01" placeholder="-"
                            onchange="saveGrade('${student.id}', 'score', this.value, this)"
                            oninput="validateScore(this, ${maxScore})">
                        <span class="save-status" id="status-${student.id}"></span>
                    </td>
                    <td>
                        <input type="text" style="width: 150px; padding: 6px 8px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.9em;"
                            value="${escapeHtml(notesValue)}" placeholder="Notes..."
                            onchange="saveGrade('${student.id}', 'notes', this.value, this)">
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function validateScore(input, maxScore) {
        const value = parseFloat(input.value);
        if (input.value !== '' && (isNaN(value) || value < 0 || value > maxScore)) {
            input.classList.add('invalid');
        } else {
            input.classList.remove('invalid');
        }
    }

    // --- Saving Grades ---

    async function saveGrade(studentId, field, value, input) {
        const timeoutKey = `${studentId}-${field}`;

        if (saveTimeout[timeoutKey]) {
            clearTimeout(saveTimeout[timeoutKey]);
        }

        const statusEl = document.getElementById(`status-${studentId}`);

        // Validate score
        if (field === 'score') {
            const maxScore = currentAssessment ? currentAssessment.max_score : 100;
            if (value !== '' && (isNaN(parseFloat(value)) || parseFloat(value) < 0 || parseFloat(value) > maxScore)) {
                statusEl.textContent = 'Invalid';
                statusEl.className = 'save-status error';
                return;
            }
        }

        // Debounce
        saveTimeout[timeoutKey] = setTimeout(async () => {
            statusEl.textContent = 'Saving...';
            statusEl.className = 'save-status saving';

            try {
                const data = {
                    student_id: studentId,
                    assessment_id: currentAssessmentId
                };

                if (field === 'score') {
                    data.score = value === '' ? null : parseFloat(value);
                } else if (field === 'notes') {
                    data.notes = value;
                }

                const response = await fetch('/api/admin/grades', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Failed to save');

                // Update local data
                const record = currentRecords.find(r => r.id === studentId);
                if (record) {
                    if (!record.grades[currentAssessmentId]) {
                        record.grades[currentAssessmentId] = {};
                    }
                    record.grades[currentAssessmentId][field] = data[field];
                }

                statusEl.textContent = 'Saved';
                statusEl.className = 'save-status saved';

                // Reload stats
                const statsResponse = await fetch(`/api/admin/assessments/${currentAssessmentId}/stats`);
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    updateStats(stats);
                }

                setTimeout(() => { statusEl.textContent = ''; }, 2000);
            } catch (error) {
                console.error('Error saving grade:', error);
                statusEl.textContent = 'Error';
                statusEl.className = 'save-status error';
            }
        }, 500);
    }

    // --- Assessment Modal ---

    function openNewAssessmentModal() {
        document.getElementById('assessmentModalTitle').textContent = 'New Assessment';
        document.getElementById('editAssessmentId').value = '';
        document.getElementById('assessmentForm').reset();
        document.getElementById('maxScore').value = '100';
        openModal(document.getElementById('assessmentModal'));
    }

    function openEditAssessmentModal() {
        if (!currentAssessment) return;

        document.getElementById('assessmentModalTitle').textContent = 'Edit Assessment';
        document.getElementById('editAssessmentId').value = currentAssessment.id;
        document.getElementById('assessmentNameInput').value = currentAssessment.name;
        document.getElementById('assessmentType').value = currentAssessment.type;
        document.getElementById('maxScore').value = currentAssessment.max_score;
        document.getElementById('weight').value = currentAssessment.weight || '';
        document.getElementById('dueDate').value = currentAssessment.due_date ? currentAssessment.due_date.slice(0, 16) : '';
        document.getElementById('assessmentDescription').value = currentAssessment.description || '';

        openModal(document.getElementById('assessmentModal'));
    }

    function closeAssessmentModal() {
        closeModal(document.getElementById('assessmentModal'));
    }

    async function saveAssessment(event) {
        event.preventDefault();

        const editId = document.getElementById('editAssessmentId').value;
        const data = {
            class_id: currentClassId,
            name: document.getElementById('assessmentNameInput').value,
            type: document.getElementById('assessmentType').value,
            max_score: parseFloat(document.getElementById('maxScore').value) || 100,
            weight: document.getElementById('weight').value ? parseFloat(document.getElementById('weight').value) : null,
            due_date: document.getElementById('dueDate').value || null,
            description: document.getElementById('assessmentDescription').value || null
        };

        try {
            let response;
            if (editId) {
                response = await fetch(`/api/admin/assessments/${editId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                response = await fetch('/api/admin/assessments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }

            if (!response.ok) throw new Error('Failed to save assessment');

            showAlert(editId ? 'Assessment updated!' : 'Assessment created!', 'success');
            closeAssessmentModal();

            // Reload assessments
            await onClassChange();

            // If we created a new one, select it
            if (!editId) {
                const newAssessments = await (await fetch(`/api/admin/assessments/${currentClassId}`)).json();
                const newOne = newAssessments.find(a => a.name === data.name);
                if (newOne) {
                    document.getElementById('assessmentFilter').value = newOne.id;
                    await onAssessmentChange();
                }
            } else {
                // Refresh current assessment
                document.getElementById('assessmentFilter').value = editId;
                await onAssessmentChange();
            }

        } catch (error) {
            console.error('Error saving assessment:', error);
            showAlert('Failed to save assessment: ' + error.message, 'error');
        }
    }

    // --- Modal Helpers ---

    function openModal(modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal(modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }

    // --- Other Actions ---

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        filterRecords();
    }

    function exportCSV() {
        if (filteredRecords.length === 0) {
            showAlert('No records to export', 'error');
            return;
        }

        const selectedClass = allClasses.find(c => c.id === currentClassId);
        const className = selectedClass ? `${selectedClass.course_code}_${selectedClass.section}` : 'class';
        const assessmentName = currentAssessment ? currentAssessment.name.replace(/\s+/g, '_') : 'grades';

        let csv = 'Campus ID,First Name,Last Name,Program,Score,Notes\n';

        filteredRecords.forEach(student => {
            const grade = student.grades[currentAssessmentId] || {};
            const score = grade.score !== null && grade.score !== undefined ? grade.score : '';
            const notes = (grade.notes || '').replace(/"/g, '""');
            csv += `${student.campus_id},"${student.first_name}","${student.last_name}",${student.program || ''},${score},"${notes}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `grades_${className}_${assessmentName}.csv`;
        a.click();
        showAlert('Grades exported successfully!', 'success');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showAlert(message, type = 'success') {
        const container = document.getElementById('alertContainer');
        const alertClass = type === 'error' ? 'alert-error' : 'alert-success';
        container.innerHTML = `<div class="alert ${alertClass}" onclick="this.remove()">${message}</div>`;
        setTimeout(() => container.innerHTML = '', 5000);
    }
</script>
{% endblock %}
