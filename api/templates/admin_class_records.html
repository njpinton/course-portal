{% extends "base_layout.html" %}

{% block title %}Class Records - Admin{% endblock %}

{% block extra_css %}
<style>
    /* Class Records Page Styles */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: linear-gradient(135deg, var(--up-green) 0%, var(--up-green-dark) 100%); color: white; padding: 20px; border-radius: var(--radius-lg); text-align: center; box-shadow: var(--shadow); }
    .stat-card h3 { font-size: 0.9em; margin-bottom: 10px; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-card .value { font-size: 2em; font-weight: bold; }

    /* Controls */
    .controls { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
    .controls input, .controls select { padding: 10px 14px; border: 2px solid var(--border); border-radius: var(--radius); font-size: 0.95em; background: var(--bg-white); }
    .controls input { flex: 1; min-width: 250px; }
    .controls input:focus, .controls select:focus { outline: none; border-color: var(--up-green); box-shadow: 0 0 0 3px var(--primary-light); }

    /* Table */
    .table-wrapper { overflow-x: auto; margin-bottom: 20px; background: var(--bg-white); border-radius: var(--radius-lg); border: 1px solid var(--border); }
    .records-table { width: 100%; border-collapse: collapse; }
    .records-table th { background: var(--up-green); color: white; padding: 14px 16px; text-align: left; font-weight: 600; font-size: 0.9em; position: sticky; top: 0; }
    .records-table td { padding: 12px 16px; border-bottom: 1px solid var(--border-light); vertical-align: middle; }
    .records-table tbody tr:hover { background: var(--primary-light); }
    .records-table a { color: var(--up-green); }

    /* Checkbox styling */
    .exam-checkbox { width: 20px; height: 20px; cursor: pointer; accent-color: var(--up-green); }
    .exam-checkbox:disabled { cursor: not-allowed; opacity: 0.5; }

    /* Score input */
    .score-input { width: 80px; padding: 6px 10px; border: 1px solid var(--border); border-radius: var(--radius); text-align: center; font-size: 0.95em; }
    .score-input:focus { outline: none; border-color: var(--up-green); box-shadow: 0 0 0 2px var(--primary-light); }
    .score-input:disabled { background: var(--bg-muted); cursor: not-allowed; }
    .score-input.invalid { border-color: #dc2626; }

    /* Save indicator */
    .save-status { font-size: 0.85em; margin-left: 8px; }
    .save-status.saving { color: var(--up-gold); }
    .save-status.saved { color: var(--up-green); }
    .save-status.error { color: #dc2626; }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 40px; color: var(--text-muted); }
    .empty-state-icon { font-size: 3em; margin-bottom: 16px; opacity: 0.5; }

    /* Page Header */
    .page-title { color: var(--up-green); font-size: 1.6em; margin-bottom: 8px; }
    .page-subtitle { color: var(--text-secondary); font-size: 0.95em; margin-bottom: 24px; }

    /* Group badge */
    .group-badge { display: inline-block; padding: 3px 10px; background: var(--primary-light); color: var(--up-green); border-radius: 12px; font-size: 0.85em; }
    .no-group { color: var(--text-muted); font-style: italic; }

    /* Responsive */
    @media (max-width: 768px) {
        .controls { flex-direction: column; }
        .controls input, .controls select { width: 100%; min-width: auto; }
        .stat-card .value { font-size: 1.6em; }
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<a href="/" class="breadcrumb-item">Home</a>
<span class="breadcrumb-separator">/</span>
<a href="/admin" class="breadcrumb-item">Admin</a>
<span class="breadcrumb-separator">/</span>
<span class="breadcrumb-current">Class Records</span>
{% endblock %}

{% block content %}
<h1 class="page-title">Class Records</h1>
<p class="page-subtitle">Track exam submissions and scores per semester</p>

<!-- Alert Messages -->
<div id="alertContainer"></div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <h3>Total Students</h3>
        <div class="value" id="totalStudents">-</div>
    </div>
    <div class="stat-card">
        <h3>Exams Submitted</h3>
        <div class="value" id="submittedCount">-</div>
    </div>
    <div class="stat-card">
        <h3>Submission Rate</h3>
        <div class="value" id="submissionRate">-%</div>
    </div>
    <div class="stat-card">
        <h3>Average Score</h3>
        <div class="value" id="avgScore">-</div>
    </div>
</div>

<!-- Controls -->
<div class="controls">
    <select id="classFilter" aria-label="Select class">
        <option value="">Select a class...</option>
    </select>
    <input type="text" id="searchInput" placeholder="Search by name or campus ID..." aria-label="Search students">
    <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
    <button class="btn btn-primary" onclick="exportCSV()">Export CSV</button>
</div>

<!-- Records Table -->
<div id="tableContainer">
    <div class="empty-state">
        <div class="empty-state-icon">&#128203;</div>
        <p>Select a class to view student records</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allClasses = [];
    let currentRecords = [];
    let filteredRecords = [];
    let saveTimeout = {};

    document.addEventListener('DOMContentLoaded', function() {
        loadClasses();
        setupEventListeners();
    });

    function setupEventListeners() {
        document.getElementById('classFilter').addEventListener('change', loadClassRecords);
        document.getElementById('searchInput').addEventListener('input', filterRecords);
    }

    async function loadClasses() {
        try {
            const response = await fetch('/api/admin/classes');
            if (!response.ok) throw new Error('Failed to load classes');
            allClasses = await response.json();

            const select = document.getElementById('classFilter');
            allClasses.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = `${cls.course_code} ${cls.section} - ${cls.semester || 'No Semester'}`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading classes:', error);
            showAlert('Failed to load classes: ' + error.message, 'error');
        }
    }

    async function loadClassRecords() {
        const classId = document.getElementById('classFilter').value;
        if (!classId) {
            document.getElementById('tableContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">&#128203;</div>
                    <p>Select a class to view student records</p>
                </div>
            `;
            resetStats();
            return;
        }

        document.getElementById('tableContainer').innerHTML = `
            <div class="empty-state">
                <div class="spinner"></div>
                <p>Loading class records...</p>
            </div>
        `;

        try {
            const response = await fetch(`/api/admin/class-records/${classId}`);
            if (!response.ok) throw new Error('Failed to load class records');
            currentRecords = await response.json();
            filterRecords();
        } catch (error) {
            console.error('Error loading records:', error);
            showAlert('Failed to load class records: ' + error.message, 'error');
            document.getElementById('tableContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">&#9888;</div>
                    <p>Failed to load records. Please try again.</p>
                </div>
            `;
        }
    }

    function filterRecords() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        filteredRecords = currentRecords.filter(student => {
            const fullName = `${student.first_name} ${student.last_name}`.toLowerCase();
            return !searchTerm ||
                fullName.includes(searchTerm) ||
                student.campus_id.toLowerCase().includes(searchTerm);
        });

        updateStats();
        displayRecords();
    }

    function updateStats() {
        const total = filteredRecords.length;
        const submitted = filteredRecords.filter(s => s.exam_submitted).length;
        const scores = filteredRecords.filter(s => s.exam_score !== null && s.exam_score !== undefined).map(s => parseFloat(s.exam_score));
        const avgScore = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : '-';
        const rate = total > 0 ? Math.round((submitted / total) * 100) : 0;

        document.getElementById('totalStudents').textContent = total;
        document.getElementById('submittedCount').textContent = submitted;
        document.getElementById('submissionRate').textContent = rate + '%';
        document.getElementById('avgScore').textContent = avgScore;
    }

    function resetStats() {
        document.getElementById('totalStudents').textContent = '-';
        document.getElementById('submittedCount').textContent = '-';
        document.getElementById('submissionRate').textContent = '-%';
        document.getElementById('avgScore').textContent = '-';
    }

    function displayRecords() {
        const container = document.getElementById('tableContainer');

        if (filteredRecords.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">&#128269;</div>
                    <p>No students found matching your criteria.</p>
                </div>
            `;
            return;
        }

        let html = `
            <div class="table-wrapper">
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>Campus ID</th>
                            <th>Name</th>
                            <th>Program</th>
                            <th>Group</th>
                            <th style="text-align: center;">Exam Submitted</th>
                            <th style="text-align: center;">Exam Score</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        filteredRecords.forEach(student => {
            const fullName = `${student.first_name} ${student.last_name}`;
            const isChecked = student.exam_submitted ? 'checked' : '';
            const scoreValue = student.exam_score !== null && student.exam_score !== undefined ? student.exam_score : '';
            const groupDisplay = student.group_name
                ? `<span class="group-badge">${escapeHtml(student.group_name)}</span>`
                : '<span class="no-group">No group</span>';

            html += `
                <tr data-student-id="${student.id}">
                    <td><strong>${escapeHtml(student.campus_id)}</strong></td>
                    <td>${escapeHtml(fullName)}</td>
                    <td>${escapeHtml(student.program || '-')}</td>
                    <td>${groupDisplay}</td>
                    <td style="text-align: center;">
                        <input type="checkbox" class="exam-checkbox" ${isChecked}
                            onchange="updateExamSubmitted('${student.id}', this.checked, this)">
                        <span class="save-status" id="status-check-${student.id}"></span>
                    </td>
                    <td style="text-align: center;">
                        <input type="number" class="score-input" value="${scoreValue}"
                            min="0" max="100" step="0.01" placeholder="-"
                            onchange="updateExamScore('${student.id}', this.value, this)"
                            oninput="validateScore(this)">
                        <span class="save-status" id="status-score-${student.id}"></span>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function validateScore(input) {
        const value = parseFloat(input.value);
        if (input.value !== '' && (isNaN(value) || value < 0 || value > 100)) {
            input.classList.add('invalid');
        } else {
            input.classList.remove('invalid');
        }
    }

    async function updateExamSubmitted(studentId, submitted, checkbox) {
        const statusEl = document.getElementById(`status-check-${studentId}`);
        statusEl.textContent = 'Saving...';
        statusEl.className = 'save-status saving';
        checkbox.disabled = true;

        try {
            const response = await fetch(`/api/admin/class-records/student/${studentId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ exam_submitted: submitted })
            });

            if (!response.ok) throw new Error('Failed to update');

            // Update local data
            const record = currentRecords.find(r => r.id === studentId);
            if (record) record.exam_submitted = submitted;

            statusEl.textContent = 'Saved';
            statusEl.className = 'save-status saved';
            updateStats();

            setTimeout(() => { statusEl.textContent = ''; }, 2000);
        } catch (error) {
            console.error('Error updating exam status:', error);
            statusEl.textContent = 'Error';
            statusEl.className = 'save-status error';
            checkbox.checked = !submitted; // Revert
        } finally {
            checkbox.disabled = false;
        }
    }

    async function updateExamScore(studentId, score, input) {
        // Clear previous timeout for this student
        if (saveTimeout[studentId]) {
            clearTimeout(saveTimeout[studentId]);
        }

        const statusEl = document.getElementById(`status-score-${studentId}`);

        // Validate
        if (score !== '' && (isNaN(parseFloat(score)) || parseFloat(score) < 0 || parseFloat(score) > 100)) {
            statusEl.textContent = 'Invalid';
            statusEl.className = 'save-status error';
            return;
        }

        // Debounce the save
        saveTimeout[studentId] = setTimeout(async () => {
            statusEl.textContent = 'Saving...';
            statusEl.className = 'save-status saving';
            input.disabled = true;

            try {
                const scoreValue = score === '' ? null : parseFloat(score);
                const response = await fetch(`/api/admin/class-records/student/${studentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ exam_score: scoreValue })
                });

                if (!response.ok) throw new Error('Failed to update');

                // Update local data
                const record = currentRecords.find(r => r.id === studentId);
                if (record) record.exam_score = scoreValue;

                statusEl.textContent = 'Saved';
                statusEl.className = 'save-status saved';
                updateStats();

                setTimeout(() => { statusEl.textContent = ''; }, 2000);
            } catch (error) {
                console.error('Error updating score:', error);
                statusEl.textContent = 'Error';
                statusEl.className = 'save-status error';
            } finally {
                input.disabled = false;
            }
        }, 500);
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        filterRecords();
    }

    function exportCSV() {
        if (filteredRecords.length === 0) {
            showAlert('No records to export', 'error');
            return;
        }

        const classId = document.getElementById('classFilter').value;
        const selectedClass = allClasses.find(c => c.id === classId);
        const className = selectedClass ? `${selectedClass.course_code}_${selectedClass.section}` : 'class';

        let csv = 'Campus ID,First Name,Last Name,Program,Group,Exam Submitted,Exam Score\n';

        filteredRecords.forEach(student => {
            const submitted = student.exam_submitted ? 'Yes' : 'No';
            const score = student.exam_score !== null && student.exam_score !== undefined ? student.exam_score : '';
            const group = student.group_name || '';
            csv += `${student.campus_id},"${student.first_name}","${student.last_name}",${student.program || ''},"${group}",${submitted},${score}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `class_records_${className}.csv`;
        a.click();
        showAlert('Records exported successfully!', 'success');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showAlert(message, type = 'success') {
        const container = document.getElementById('alertContainer');
        const alertClass = type === 'error' ? 'alert-error' : 'alert-success';
        container.innerHTML = `<div class="alert ${alertClass}" onclick="this.remove()">${message}</div>`;
        setTimeout(() => container.innerHTML = '', 5000);
    }
</script>
{% endblock %}
